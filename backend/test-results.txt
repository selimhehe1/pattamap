
> backend@1.0.0 test
> jest

PASS src/controllers/__tests__/ownershipRequestController.test.ts (17.404 s)
  OwnershipRequestController
    createOwnershipRequest
      ‚àö should create ownership request successfully for existing establishment (77 ms)
      ‚àö should return 400 for missing establishment_id and establishment_data (3 ms)
      ‚àö should return 400 for missing documents (3 ms)
      ‚àö should return 403 if user is not establishment_owner (3 ms)
      ‚àö should return 409 if user already has pending request (7 ms)
    getMyOwnershipRequests
      ‚àö should return user ownership requests (4 ms)
      ‚àö should return empty array if no requests (3 ms)
    getAllOwnershipRequests
      ‚àö should return all ownership requests (4 ms)
      ‚àö should return empty array if no requests (3 ms)
    approveOwnershipRequest
      ‚àö should approve ownership request successfully (6 ms)
      ‚àö should return 404 if request not found (3 ms)
      ‚àö should return 400 if request already processed (3 ms)
    rejectOwnershipRequest
      ‚àö should reject ownership request successfully (3 ms)
      ‚àö should return 400 if admin_notes missing (2 ms)
      ‚àö should return 404 if request not found (2 ms)
    cancelOwnershipRequest
      ‚àö should cancel ownership request successfully (4 ms)
      ‚àö should return 404 if request not found (12 ms)
      ‚àö should return 403 if user tries to cancel another user request (2 ms)

  console.warn
    ‚ö†Ô∏è [2025-11-01T15:06:04.797Z] [WARN] ‚ö†Ô∏è VAPID keys not configured. Push notifications will not work.

    [0m [90m 125 |[39m   warn(message[33m:[39m string[33m,[39m data[33m?[39m[33m:[39m any[33m,[39m options[33m?[39m[33m:[39m [33mLogOptions[39m) {
     [90m 126 |[39m     [36mif[39m ([36mthis[39m[33m.[39mminLevel [33m<=[39m [33mLogLevel[39m[33m.[39m[33mWARN[39m) {
    [31m[1m>[22m[39m[90m 127 |[39m       console[33m.[39mwarn([36mthis[39m[33m.[39mformatMessage([32m'WARN'[39m[33m,[39m message[33m,[39m data[33m,[39m options))[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 128 |[39m     }
     [90m 129 |[39m   }
     [90m 130 |[39m[0m

      at Logger.warn (src/utils/logger.ts:127:15)
      at Object.<anonymous> (src/services/pushService.ts:24:10)
      at Object.<anonymous> (src/utils/notificationHelper.ts:4:1)
      at Object.<anonymous> (src/controllers/vipController.ts:25:1)
      at Object.<anonymous> (src/__tests__/vip/vipPurchase.test.ts:15:1)

  console.warn
    ‚ö†Ô∏è [2025-11-01T15:06:05.230Z] [WARN] Generate keys with: npx web-push generate-vapid-keys

    [0m [90m 125 |[39m   warn(message[33m:[39m string[33m,[39m data[33m?[39m[33m:[39m any[33m,[39m options[33m?[39m[33m:[39m [33mLogOptions[39m) {
     [90m 126 |[39m     [36mif[39m ([36mthis[39m[33m.[39mminLevel [33m<=[39m [33mLogLevel[39m[33m.[39m[33mWARN[39m) {
    [31m[1m>[22m[39m[90m 127 |[39m       console[33m.[39mwarn([36mthis[39m[33m.[39mformatMessage([32m'WARN'[39m[33m,[39m message[33m,[39m data[33m,[39m options))[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 128 |[39m     }
     [90m 129 |[39m   }
     [90m 130 |[39m[0m

      at Logger.warn (src/utils/logger.ts:127:15)
      at Object.<anonymous> (src/services/pushService.ts:25:10)
      at Object.<anonymous> (src/utils/notificationHelper.ts:4:1)
      at Object.<anonymous> (src/controllers/vipController.ts:25:1)
      at Object.<anonymous> (src/__tests__/vip/vipPurchase.test.ts:15:1)

PASS src/controllers/__tests__/moderationController.test.ts (19.799 s)
  ModerationController
    getModerationQueue
      ‚àö should return moderation queue items successfully (51 ms)
      ‚àö should return empty array when no items in queue (11 ms)
    approveItem
      ‚àö should approve moderation item successfully (8 ms)
      ‚àö should return 404 if moderation item not found (4 ms)
    rejectItem
      ‚àö should reject moderation item successfully (6 ms)
      ‚àö should return 400 if moderator notes are missing (2 ms)
    getModerationStats
      ‚àö should return moderation statistics (7 ms)
      ‚àö should handle errors gracefully (2 ms)
    getReports
      ‚àö should return user reports successfully (3 ms)
      ‚àö should return empty array when no reports (2 ms)
    resolveReport
      ‚àö should resolve report with dismiss action (4 ms)
      ‚àö should return 404 if report not found (2 ms)

PASS src/controllers/__tests__/commentController.test.ts (20.123 s)
  CommentController
    getComments
      ‚àö should return comments for an employee (36 ms)
      ‚àö should return 400 if employee_id is missing (3 ms)
      ‚àö should handle database errors (4 ms)
    createComment
      ‚àö should create a comment successfully (20 ms)
      ‚àö should create a comment with rating (13 ms)
      ‚àö should return 400 for missing required fields (2 ms)
      ‚àö should return 400 for invalid rating (2 ms)
      ‚àö should return 404 if employee not found (3 ms)
      ‚àö should return 400 if user already rated employee (5 ms)
    updateComment
      ‚àö should allow owner to update own comment (4 ms)
      ‚àö should allow admin to update any comment (3 ms)
      ‚àö should deny update for non-owner non-admin (3 ms)
      ‚àö should return 404 for non-existent comment (2 ms)
    deleteComment
      ‚àö should allow owner to delete own comment (3 ms)
      ‚àö should allow admin to delete any comment (3 ms)
      ‚àö should deny delete for non-owner non-admin (2 ms)
    reportComment
      ‚àö should report a comment successfully (3 ms)
      ‚àö should return 400 if reason is missing (11 ms)
      ‚àö should return 404 if comment not found (2 ms)
      ‚àö should return 400 if user already reported comment (3 ms)
    getEmployeeRatings
      ‚àö should return employee ratings with distribution (3 ms)
      ‚àö should return null average for no ratings (2 ms)
    getUserRating
      ‚àö should return user rating for employee (3 ms)
      ‚àö should return null if user has not rated (2 ms)
    updateUserRating
      ‚àö should create new rating if none exists (3 ms)
      ‚àö should update existing rating (3 ms)
      ‚àö should return 400 for invalid rating (2 ms)
      ‚àö should return 404 if employee not found (3 ms)

  console.log
    üîç [2025-11-01T15:06:07.489Z] [DEBUG] CSRF token generator
    {
      "method": "GET",
      "url": "/csrf-token",
      "hasSession": true,
      "hasExistingToken": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:07.754Z] [DEBUG] CSRF token generated and session saved
    {
      "tokenLength": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:07.760Z] [DEBUG] CSRF token requested

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:07.828Z] [DEBUG] CSRF token generator
    {
      "method": "GET",
      "url": "/csrf-token",
      "hasSession": true,
      "hasExistingToken": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:07.835Z] [DEBUG] CSRF token generated and session saved
    {
      "tokenLength": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:07.839Z] [DEBUG] CSRF token requested

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:07.862Z] [DEBUG] CSRF token generator
    {
      "method": "GET",
      "url": "/csrf-token",
      "hasSession": true,
      "hasExistingToken": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:07.865Z] [DEBUG] CSRF token reused from session

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:07.868Z] [DEBUG] CSRF token requested

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:07.895Z] [DEBUG] CSRF token generator
    {
      "method": "GET",
      "url": "/public",
      "hasSession": true,
      "hasExistingToken": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:07.902Z] [DEBUG] CSRF token generated and session saved
    {
      "tokenLength": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:07.904Z] [DEBUG] CSRF protection check
    {
      "method": "GET",
      "url": "/public"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

PASS src/controllers/__tests__/notificationController.test.ts (20.232 s)
  NotificationController
    getMyNotifications
      ‚àö should return user's notifications with default limit (36 ms)
      ‚àö should filter unread notifications when unread_only=true (2 ms)
      ‚àö should apply custom limit from query params (3 ms)
      ‚àö should return empty array when no notifications found (2 ms)
      ‚àö should handle database errors (3 ms)
    getUnreadCount
      ‚àö should return unread notification count (3 ms)
      ‚àö should return 0 if user has no unread notifications (2 ms)
      ‚àö should handle errors gracefully (2 ms)
    markAsRead
      ‚àö should mark notification as read (3 ms)
      ‚àö should return 404 if notification not found or does not belong to user (2 ms)
      ‚àö should handle errors gracefully (2 ms)
    markAllRead
      ‚àö should mark all user's notifications as read (3 ms)
      ‚àö should handle database errors (2 ms)
      ‚àö should handle unexpected errors gracefully (2 ms)
    deleteNotification
      ‚àö should delete user's notification (2 ms)
      ‚àö should succeed even if notification does not exist (idempotent) (1 ms)
      ‚àö should handle database errors (1 ms)
      ‚àö should handle unexpected errors (1 ms)

  console.log
    üîç [2025-11-01T15:06:07.906Z] [DEBUG] CSRF check skipped for safe method
    {
      "method": "GET"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:07.931Z] [DEBUG] CSRF token generator
    {
      "method": "HEAD",
      "url": "/public",
      "hasSession": true,
      "hasExistingToken": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:07.937Z] [DEBUG] CSRF token generated and session saved
    {
      "tokenLength": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:07.939Z] [DEBUG] CSRF protection check
    {
      "method": "HEAD",
      "url": "/public"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:07.942Z] [DEBUG] CSRF check skipped for safe method
    {
      "method": "HEAD"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:07.965Z] [DEBUG] CSRF token generator
    {
      "method": "OPTIONS",
      "url": "/protected",
      "hasSession": true,
      "hasExistingToken": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:07.971Z] [DEBUG] CSRF token generated and session saved
    {
      "tokenLength": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:07.973Z] [DEBUG] CSRF protection check
    {
      "method": "OPTIONS",
      "url": "/protected"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:07.975Z] [DEBUG] CSRF check skipped for safe method
    {
      "method": "OPTIONS"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

PASS src/controllers/__tests__/employeeController.test.ts (20.468 s)
  EmployeeController
    getEmployees
      ‚àö should return list of employees with pagination and ratings (46 ms)
      ‚àö should filter employees by nationality (4 ms)
      ‚àö should filter employees by age range (5 ms)
      ‚àö should search employees by name/nickname/description (3 ms)
      ‚àö should handle database errors (4 ms)
    getEmployee
      ‚àö should return employee by ID with full details (4 ms)
      ‚àö should return 404 for non-existent employee (3 ms)
    createEmployee
      ‚àö should create employee with establishment employment (7 ms)
      ‚àö should create employee with freelance position (10 ms)
      ‚àö should return 400 for missing required fields (3 ms)
      ‚àö should return 400 for too many photos (2 ms)
      ‚àö should return 400 when both establishment and freelance provided (3 ms)
      ‚àö should return 400 when freelance works at non-nightclub establishment (2 ms)
    updateEmployee
      ‚àö should allow creator to update own employee (5 ms)
      ‚àö should allow admin to update any employee without pending status (4 ms)
      ‚àö should deny update for non-owner non-admin user (3 ms)
      ‚àö should return 404 for non-existent employee (2 ms)
      ‚àö should toggle freelance mode and deactivate employment (4 ms)
    deleteEmployee
      ‚àö should allow creator to delete own employee (3 ms)
      ‚àö should allow admin to delete any employee (3 ms)
      ‚àö should deny delete for non-owner non-admin user (2 ms)
      ‚àö should return 404 for non-existent employee (1 ms)
    addEmployment
      ‚àö should add employment history entry (3 ms)
      ‚àö should return 400 for missing required fields (1 ms)
    getEmployeeNameSuggestions
      ‚àö should return suggestions for search query (42 ms)
      ‚àö should return empty array for empty query (2 ms)
    createOwnEmployeeProfile (Employee Claim System v10.0)
      ‚àö should create self-managed employee profile (4 ms)
      ‚àö should return 409 if user already has linked profile (2 ms)
    claimEmployeeProfile (Employee Claim System v10.0)
      ‚àö should create claim request for existing profile (4 ms)
      ‚àö should return 400 for too short message (1 ms)
      ‚àö should return 409 if employee already linked (2 ms)
    getMyLinkedProfile
      ‚àö should return linked employee profile (4 ms)
      ‚àö should return 404 if user has no linked profile (2 ms)
    getClaimRequests (Admin)
      ‚àö should return claim requests for admin (3 ms)
      ‚àö should deny access for non-admin (1 ms)
    approveClaimRequest (Admin)
      ‚àö should approve claim and create user-employee link (4 ms)
      ‚àö should deny access for non-admin (1 ms)
    rejectClaimRequest (Admin)
      ‚àö should reject claim with reason (2 ms)
      ‚àö should return 400 for too short rejection reason (1 ms)
      ‚àö should deny access for non-admin (1 ms)

  console.log
    üîç [2025-11-01T15:06:08.087Z] [DEBUG] CSRF token generator
    {
      "method": "POST",
      "url": "/protected",
      "hasSession": true,
      "hasExistingToken": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.094Z] [DEBUG] CSRF token generated and session saved
    {
      "tokenLength": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.096Z] [DEBUG] CSRF protection check
    {
      "method": "POST",
      "url": "/protected"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.098Z] [DEBUG] CSRF tokens check
    {
      "method": "POST",
      "url": "/protected",
      "sessionId": "[REDACTED]",
      "sessionToken": "[REDACTED]",
      "requestToken": "[REDACTED]",
      "hasSessionToken": "[REDACTED]",
      "hasRequestToken": "[REDACTED]",
      "requestTokenSource": "[REDACTED]",
      "tokensMatch": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.warn
    ‚ö†Ô∏è [2025-11-01T15:06:08.100Z] [WARN] CSRF validation failed
    {
      "reason": "request_token_missing"
    }

    [0m [90m 125 |[39m   warn(message[33m:[39m string[33m,[39m data[33m?[39m[33m:[39m any[33m,[39m options[33m?[39m[33m:[39m [33mLogOptions[39m) {
     [90m 126 |[39m     [36mif[39m ([36mthis[39m[33m.[39mminLevel [33m<=[39m [33mLogLevel[39m[33m.[39m[33mWARN[39m) {
    [31m[1m>[22m[39m[90m 127 |[39m       console[33m.[39mwarn([36mthis[39m[33m.[39mformatMessage([32m'WARN'[39m[33m,[39m message[33m,[39m data[33m,[39m options))[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 128 |[39m     }
     [90m 129 |[39m   }
     [90m 130 |[39m[0m

      at Logger.warn (src/utils/logger.ts:127:15)
      at csrfProtection (src/middleware/csrf.ts:124:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Immediate._onImmediate (src/middleware/csrf.ts:53:7)

  console.log
    üîç [2025-11-01T15:06:08.150Z] [DEBUG] CSRF token generator
    {
      "method": "PUT",
      "url": "/protected/123",
      "hasSession": true,
      "hasExistingToken": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.154Z] [DEBUG] CSRF token generated and session saved
    {
      "tokenLength": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.156Z] [DEBUG] CSRF protection check
    {
      "method": "PUT",
      "url": "/protected/123"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.159Z] [DEBUG] CSRF tokens check
    {
      "method": "PUT",
      "url": "/protected/123",
      "sessionId": "[REDACTED]",
      "sessionToken": "[REDACTED]",
      "requestToken": "[REDACTED]",
      "hasSessionToken": "[REDACTED]",
      "hasRequestToken": "[REDACTED]",
      "requestTokenSource": "[REDACTED]",
      "tokensMatch": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.warn
    ‚ö†Ô∏è [2025-11-01T15:06:08.161Z] [WARN] CSRF validation failed
    {
      "reason": "request_token_missing"
    }

    [0m [90m 125 |[39m   warn(message[33m:[39m string[33m,[39m data[33m?[39m[33m:[39m any[33m,[39m options[33m?[39m[33m:[39m [33mLogOptions[39m) {
     [90m 126 |[39m     [36mif[39m ([36mthis[39m[33m.[39mminLevel [33m<=[39m [33mLogLevel[39m[33m.[39m[33mWARN[39m) {
    [31m[1m>[22m[39m[90m 127 |[39m       console[33m.[39mwarn([36mthis[39m[33m.[39mformatMessage([32m'WARN'[39m[33m,[39m message[33m,[39m data[33m,[39m options))[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 128 |[39m     }
     [90m 129 |[39m   }
     [90m 130 |[39m[0m

      at Logger.warn (src/utils/logger.ts:127:15)
      at csrfProtection (src/middleware/csrf.ts:124:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Immediate._onImmediate (src/middleware/csrf.ts:53:7)

  console.log
    üîç [2025-11-01T15:06:08.191Z] [DEBUG] CSRF token generator
    {
      "method": "GET",
      "url": "/csrf-token",
      "hasSession": true,
      "hasExistingToken": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.197Z] [DEBUG] CSRF token generated and session saved
    {
      "tokenLength": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.198Z] [DEBUG] CSRF token requested

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.215Z] [DEBUG] CSRF token generator
    {
      "method": "POST",
      "url": "/protected",
      "hasSession": true,
      "hasExistingToken": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.217Z] [DEBUG] CSRF token reused from session

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.219Z] [DEBUG] CSRF protection check
    {
      "method": "POST",
      "url": "/protected"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.222Z] [DEBUG] CSRF tokens check
    {
      "method": "POST",
      "url": "/protected",
      "sessionId": "[REDACTED]",
      "sessionToken": "[REDACTED]",
      "requestToken": "[REDACTED]",
      "hasSessionToken": "[REDACTED]",
      "hasRequestToken": "[REDACTED]",
      "requestTokenSource": "[REDACTED]",
      "tokensMatch": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.225Z] [DEBUG] CSRF validation successful

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.243Z] [DEBUG] CSRF token generator
    {
      "method": "GET",
      "url": "/csrf-token",
      "hasSession": true,
      "hasExistingToken": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.248Z] [DEBUG] CSRF token generated and session saved
    {
      "tokenLength": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.250Z] [DEBUG] CSRF token requested

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.264Z] [DEBUG] CSRF token generator
    {
      "method": "PUT",
      "url": "/protected/456",
      "hasSession": true,
      "hasExistingToken": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.266Z] [DEBUG] CSRF token reused from session

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.268Z] [DEBUG] CSRF protection check
    {
      "method": "PUT",
      "url": "/protected/456"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.271Z] [DEBUG] CSRF tokens check
    {
      "method": "PUT",
      "url": "/protected/456",
      "sessionId": "[REDACTED]",
      "sessionToken": "[REDACTED]",
      "requestToken": "[REDACTED]",
      "hasSessionToken": "[REDACTED]",
      "hasRequestToken": "[REDACTED]",
      "requestTokenSource": "[REDACTED]",
      "tokensMatch": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.274Z] [DEBUG] CSRF validation successful

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.299Z] [DEBUG] CSRF token generator
    {
      "method": "GET",
      "url": "/csrf-token",
      "hasSession": true,
      "hasExistingToken": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.311Z] [DEBUG] CSRF token generated and session saved
    {
      "tokenLength": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.312Z] [DEBUG] CSRF token requested

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.329Z] [DEBUG] CSRF token generator
    {
      "method": "POST",
      "url": "/protected",
      "hasSession": true,
      "hasExistingToken": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.331Z] [DEBUG] CSRF token reused from session

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.334Z] [DEBUG] CSRF protection check
    {
      "method": "POST",
      "url": "/protected"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.337Z] [DEBUG] CSRF tokens check
    {
      "method": "POST",
      "url": "/protected",
      "sessionId": "[REDACTED]",
      "sessionToken": "[REDACTED]",
      "requestToken": "[REDACTED]",
      "hasSessionToken": "[REDACTED]",
      "hasRequestToken": "[REDACTED]",
      "requestTokenSource": "[REDACTED]",
      "tokensMatch": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.warn
    ‚ö†Ô∏è [2025-11-01T15:06:08.340Z] [WARN] CSRF validation failed
    {
      "reason": "token_length_mismatch"
    }

    [0m [90m 125 |[39m   warn(message[33m:[39m string[33m,[39m data[33m?[39m[33m:[39m any[33m,[39m options[33m?[39m[33m:[39m [33mLogOptions[39m) {
     [90m 126 |[39m     [36mif[39m ([36mthis[39m[33m.[39mminLevel [33m<=[39m [33mLogLevel[39m[33m.[39m[33mWARN[39m) {
    [31m[1m>[22m[39m[90m 127 |[39m       console[33m.[39mwarn([36mthis[39m[33m.[39mformatMessage([32m'WARN'[39m[33m,[39m message[33m,[39m data[33m,[39m options))[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 128 |[39m     }
     [90m 129 |[39m   }
     [90m 130 |[39m[0m

      at Logger.warn (src/utils/logger.ts:127:15)
      at csrfProtection (src/middleware/csrf.ts:136:14)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrfTokenGenerator (src/middleware/csrf.ts:62:5)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Immediate._onImmediate (node_modules/express-session/index.js:514:7)

  console.log
    üîç [2025-11-01T15:06:08.368Z] [DEBUG] CSRF token generator
    {
      "method": "GET",
      "url": "/csrf-token",
      "hasSession": true,
      "hasExistingToken": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.374Z] [DEBUG] CSRF token generated and session saved
    {
      "tokenLength": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.375Z] [DEBUG] CSRF token requested

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.391Z] [DEBUG] CSRF token generator
    {
      "method": "POST",
      "url": "/protected",
      "hasSession": true,
      "hasExistingToken": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.393Z] [DEBUG] CSRF token reused from session

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.395Z] [DEBUG] CSRF protection check
    {
      "method": "POST",
      "url": "/protected"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.398Z] [DEBUG] CSRF tokens check
    {
      "method": "POST",
      "url": "/protected",
      "sessionId": "[REDACTED]",
      "sessionToken": "[REDACTED]",
      "requestToken": "[REDACTED]",
      "hasSessionToken": "[REDACTED]",
      "hasRequestToken": "[REDACTED]",
      "requestTokenSource": "[REDACTED]",
      "tokensMatch": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.warn
    ‚ö†Ô∏è [2025-11-01T15:06:08.401Z] [WARN] CSRF validation failed
    {
      "reason": "token_content_mismatch"
    }

    [0m [90m 125 |[39m   warn(message[33m:[39m string[33m,[39m data[33m?[39m[33m:[39m any[33m,[39m options[33m?[39m[33m:[39m [33mLogOptions[39m) {
     [90m 126 |[39m     [36mif[39m ([36mthis[39m[33m.[39mminLevel [33m<=[39m [33mLogLevel[39m[33m.[39m[33mWARN[39m) {
    [31m[1m>[22m[39m[90m 127 |[39m       console[33m.[39mwarn([36mthis[39m[33m.[39mformatMessage([32m'WARN'[39m[33m,[39m message[33m,[39m data[33m,[39m options))[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 128 |[39m     }
     [90m 129 |[39m   }
     [90m 130 |[39m[0m

      at Logger.warn (src/utils/logger.ts:127:15)
      at csrfProtection (src/middleware/csrf.ts:145:14)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at csrfTokenGenerator (src/middleware/csrf.ts:62:5)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Immediate._onImmediate (node_modules/express-session/index.js:514:7)

  console.log
    üîç [2025-11-01T15:06:08.424Z] [DEBUG] CSRF token generator
    {
      "method": "POST",
      "url": "/protected",
      "hasSession": true,
      "hasExistingToken": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.428Z] [DEBUG] CSRF token generated and session saved
    {
      "tokenLength": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.429Z] [DEBUG] CSRF protection check
    {
      "method": "POST",
      "url": "/protected"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.431Z] [DEBUG] CSRF tokens check
    {
      "method": "POST",
      "url": "/protected",
      "sessionId": "[REDACTED]",
      "sessionToken": "[REDACTED]",
      "requestToken": "[REDACTED]",
      "hasSessionToken": "[REDACTED]",
      "hasRequestToken": "[REDACTED]",
      "requestTokenSource": "[REDACTED]",
      "tokensMatch": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.warn
    ‚ö†Ô∏è [2025-11-01T15:06:08.434Z] [WARN] CSRF validation failed
    {
      "reason": "token_content_mismatch"
    }

    [0m [90m 125 |[39m   warn(message[33m:[39m string[33m,[39m data[33m?[39m[33m:[39m any[33m,[39m options[33m?[39m[33m:[39m [33mLogOptions[39m) {
     [90m 126 |[39m     [36mif[39m ([36mthis[39m[33m.[39mminLevel [33m<=[39m [33mLogLevel[39m[33m.[39m[33mWARN[39m) {
    [31m[1m>[22m[39m[90m 127 |[39m       console[33m.[39mwarn([36mthis[39m[33m.[39mformatMessage([32m'WARN'[39m[33m,[39m message[33m,[39m data[33m,[39m options))[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 128 |[39m     }
     [90m 129 |[39m   }
     [90m 130 |[39m[0m

      at Logger.warn (src/utils/logger.ts:127:15)
      at csrfProtection (src/middleware/csrf.ts:145:14)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Immediate._onImmediate (src/middleware/csrf.ts:53:7)

  console.log
    üîç [2025-11-01T15:06:08.455Z] [DEBUG] CSRF token generator
    {
      "method": "GET",
      "url": "/csrf-token",
      "hasSession": true,
      "hasExistingToken": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.459Z] [DEBUG] CSRF token generated and session saved
    {
      "tokenLength": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.461Z] [DEBUG] CSRF token requested

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.508Z] [DEBUG] CSRF token generator
    {
      "method": "POST",
      "url": "/protected",
      "hasSession": true,
      "hasExistingToken": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.510Z] [DEBUG] CSRF token reused from session

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.512Z] [DEBUG] CSRF protection check
    {
      "method": "POST",
      "url": "/protected"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.515Z] [DEBUG] CSRF tokens check
    {
      "method": "POST",
      "url": "/protected",
      "sessionId": "[REDACTED]",
      "sessionToken": "[REDACTED]",
      "requestToken": "[REDACTED]",
      "hasSessionToken": "[REDACTED]",
      "hasRequestToken": "[REDACTED]",
      "requestTokenSource": "[REDACTED]",
      "tokensMatch": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.517Z] [DEBUG] CSRF validation successful

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.534Z] [DEBUG] CSRF token generator
    {
      "method": "POST",
      "url": "/api/admin/test",
      "hasSession": true,
      "hasExistingToken": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.537Z] [DEBUG] CSRF token generated and session saved
    {
      "tokenLength": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.539Z] [DEBUG] CSRF protection check
    {
      "method": "POST",
      "url": "/api/admin/test"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.541Z] [DEBUG] CSRF tokens check
    {
      "method": "POST",
      "url": "/api/admin/test",
      "sessionId": "[REDACTED]",
      "sessionToken": "[REDACTED]",
      "requestToken": "[REDACTED]",
      "hasSessionToken": "[REDACTED]",
      "hasRequestToken": "[REDACTED]",
      "requestTokenSource": "[REDACTED]",
      "tokensMatch": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.warn
    ‚ö†Ô∏è [2025-11-01T15:06:08.543Z] [WARN] CSRF validation failed
    {
      "reason": "request_token_missing"
    }

    [0m [90m 125 |[39m   warn(message[33m:[39m string[33m,[39m data[33m?[39m[33m:[39m any[33m,[39m options[33m?[39m[33m:[39m [33mLogOptions[39m) {
     [90m 126 |[39m     [36mif[39m ([36mthis[39m[33m.[39mminLevel [33m<=[39m [33mLogLevel[39m[33m.[39m[33mWARN[39m) {
    [31m[1m>[22m[39m[90m 127 |[39m       console[33m.[39mwarn([36mthis[39m[33m.[39mformatMessage([32m'WARN'[39m[33m,[39m message[33m,[39m data[33m,[39m options))[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 128 |[39m     }
     [90m 129 |[39m   }
     [90m 130 |[39m[0m

      at Logger.warn (src/utils/logger.ts:127:15)
      at csrfProtection (src/middleware/csrf.ts:124:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Immediate._onImmediate (src/middleware/csrf.ts:53:7)

  console.log
    üîç [2025-11-01T15:06:08.563Z] [DEBUG] CSRF token generator
    {
      "method": "POST",
      "url": "/protected",
      "hasSession": true,
      "hasExistingToken": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.567Z] [DEBUG] CSRF token generated and session saved
    {
      "tokenLength": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.568Z] [DEBUG] CSRF protection check
    {
      "method": "POST",
      "url": "/protected"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.log
    üîç [2025-11-01T15:06:08.570Z] [DEBUG] CSRF tokens check
    {
      "method": "POST",
      "url": "/protected",
      "sessionId": "[REDACTED]",
      "sessionToken": "[REDACTED]",
      "requestToken": "[REDACTED]",
      "hasSessionToken": "[REDACTED]",
      "hasRequestToken": "[REDACTED]",
      "requestTokenSource": "[REDACTED]",
      "tokensMatch": "[REDACTED]"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.warn
    ‚ö†Ô∏è [2025-11-01T15:06:08.572Z] [WARN] CSRF validation failed
    {
      "reason": "request_token_missing"
    }

    [0m [90m 125 |[39m   warn(message[33m:[39m string[33m,[39m data[33m?[39m[33m:[39m any[33m,[39m options[33m?[39m[33m:[39m [33mLogOptions[39m) {
     [90m 126 |[39m     [36mif[39m ([36mthis[39m[33m.[39mminLevel [33m<=[39m [33mLogLevel[39m[33m.[39m[33mWARN[39m) {
    [31m[1m>[22m[39m[90m 127 |[39m       console[33m.[39mwarn([36mthis[39m[33m.[39mformatMessage([32m'WARN'[39m[33m,[39m message[33m,[39m data[33m,[39m options))[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 128 |[39m     }
     [90m 129 |[39m   }
     [90m 130 |[39m[0m

      at Logger.warn (src/utils/logger.ts:127:15)
      at csrfProtection (src/middleware/csrf.ts:124:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Immediate._onImmediate (src/middleware/csrf.ts:53:7)

PASS src/middleware/__tests__/csrf.integration.test.ts (21.215 s)
  CSRF Protection Integration Tests
    CSRF Token Generation
      ‚àö should generate and return CSRF token (487 ms)
      ‚àö should persist CSRF token in session (69 ms)
    CSRF Protection - Safe Methods
      ‚àö should allow GET requests without CSRF token (37 ms)
      ‚àö should allow HEAD requests without CSRF token (33 ms)
      ‚àö should allow OPTIONS requests without CSRF token (41 ms)
    CSRF Protection - Unsafe Methods
      ‚àö should reject POST request without CSRF token (143 ms)
      ‚àö should reject PUT request without CSRF token (39 ms)
      ‚àö should accept POST request with valid CSRF token in header (55 ms)
      ‚àö should accept PUT request with valid CSRF token (55 ms)
      ‚àö should reject request with invalid CSRF token (67 ms)
      ‚àö should reject request with mismatched CSRF token (57 ms)
      ‚àö should reject request with token but no prior session establishment (30 ms)
    CSRF Token in Request Body
      ‚àö should accept CSRF token from request body (76 ms)
    Admin Route CSRF Protection
      ‚àö should enforce CSRF protection on admin routes (NO BYPASS) (32 ms)
      ‚àö should also enforce CSRF for non-admin routes with auth cookie (27 ms)

PASS src/services/__tests__/badgeAwardService.test.ts (21.318 s)
  BadgeAwardService
    checkAndAwardBadges
      ‚àö should award new badges when requirements are met (41 ms)
      ‚àö should not award badges that user already has (5 ms)
      ‚àö should return empty array if no badges in database (5 ms)
      ‚àö should handle database error when fetching badges (4 ms)
      ‚àö should handle database error when fetching user badges (6 ms)
      ‚àö should skip irrelevant badges for action type (4 ms)
      ‚àö should not award badge if requirements not met (4 ms)
    isBadgeRelevantForAction
      ‚àö should return true for review badges on review action (2 ms)
      ‚àö should return true for check-in badges on check-in action (2 ms)
      ‚àö should return false for mismatched action and badge type (2 ms)
      ‚àö should return false for unknown action types (2 ms)
    checkBadgeRequirements
      ‚àö should check review_count requirement (2 ms)
      ‚àö should check check_in_count requirement (2 ms)
      ‚àö should check unique_zones_visited requirement (3 ms)
      ‚àö should return false for unimplemented requirement types (2 ms)
      ‚àö should handle database errors gracefully (2 ms)
      ‚àö should return false when count is below requirement (2 ms)
    awardBadge
      ‚àö should award badge successfully (3 ms)
      ‚àö should handle duplicate badge award (unique constraint) (3 ms)
      ‚àö should handle database errors (3 ms)
      ‚àö should handle unexpected exceptions (3 ms)

PASS src/controllers/__tests__/favoriteController.test.ts (21.4 s)
  FavoriteController
    getFavorites
      ‚àö should return user favorites with employee details (42 ms)
      ‚àö should return empty array when user has no favorites (2 ms)
      ‚àö should return 401 if user not authenticated (3 ms)
    addFavorite
      ‚àö should add employee to favorites successfully (11 ms)
      ‚àö should return 409 if employee already in favorites (4 ms)
      ‚àö should return 400 if employee_id is missing (3 ms)
      ‚àö should return 401 if user not authenticated (3 ms)
    removeFavorite
      ‚àö should remove employee from favorites successfully (5 ms)
      ‚àö should handle removal even if favorite does not exist (4 ms)
      ‚àö should return 401 if user not authenticated (2 ms)
    checkFavorite
      ‚àö should return true when employee is favorited (3 ms)
      ‚àö should return false when employee is not favorited (3 ms)
      ‚àö should return 401 if user not authenticated (1 ms)

PASS src/services/__tests__/missionTrackingService.test.ts (21.698 s)
  MissionTrackingService
    Event Listeners
      onCheckIn
        ‚àö should skip mission tracking for unverified check-ins (31 ms)
        ‚àö should fetch active check-in missions on verified check-in (6 ms)
        ‚àö should handle no active missions gracefully (2 ms)
        ‚àö should handle database errors gracefully (3 ms)
      onReviewCreated
        ‚àö should fetch active review missions (10 ms)
        ‚àö should handle no active review missions gracefully (2 ms)
      onVoteCast
        ‚àö should skip non-helpful votes (2 ms)
        ‚àö should fetch active vote missions for helpful votes (3 ms)
      onFollowAction
        ‚àö should track follow missions for both follower and followed user (4 ms)
      onHelpfulVoteReceived
        ‚àö should track helpful vote received missions (4 ms)
      onPhotoUploaded
        ‚àö should track photo upload missions (Phase 3 placeholder) (3 ms)
    Mission Processing
      processCheckInMission
        ‚àö should process simple check-in mission (non-unique) (2 ms)
        ‚àö should process unique check-in mission (4 ms)
        ‚àö should process zone-specific check-in mission (3 ms)
        ‚àö should process all-zones check-in mission (2 ms)
      processReviewMission
        ‚àö should process simple review mission (2 ms)
        ‚àö should process quality review mission with min length (2 ms)
        ‚àö should process reviews with photos mission (2 ms)
        ‚àö should process reviews with min_length in requirements (3 ms)
        ‚àö should process narrative quest review missions (2 ms)
    Progress Tracking
      updateMissionProgress
        ‚àö should call update_mission_progress RPC function (2 ms)
        ‚àö should handle RPC errors gracefully (1 ms)
        ‚àö should trigger completion handling when mission completed (2 ms)
      setMissionProgress
        ‚àö should call RPC function to set progress (2 ms)
        ‚àö should handle RPC errors gracefully (1 ms)
        ‚àö should trigger completion handling when RPC returns completed=true (2 ms)
    Completion Detection
      handleMissionCompletion
        ‚àö should log completion and fetch mission details (2 ms)
        ‚àö should unlock next quest step for narrative missions (8 ms)
    Reset Mechanisms
      resetDailyMissions
        ‚àö should call reset_missions RPC with daily type (2 ms)
        ‚àö should handle reset errors gracefully (1 ms)
      resetWeeklyMissions
        ‚àö should call reset_missions RPC with weekly type (1 ms)
    Counting Helpers
      getUniqueCheckInCount
        ‚àö should count unique establishments for daily missions (2 ms)
        ‚àö should count unique establishments for weekly missions (2 ms)
        ‚àö should return 0 on database error (2 ms)
      getZoneCheckInCount
        ‚àö should count check-ins in specific zone for daily missions (2 ms)
        ‚àö should count check-ins in zone for narrative missions (all-time) (1 ms)
        ‚àö should handle errors gracefully (1 ms)
      getUniqueZonesVisited
        ‚àö should count unique zones for all-time (2 ms)
        ‚àö should count unique zones for weekly missions (1 ms)
        ‚àö should handle null zones gracefully (1 ms)
      getReviewCount
        ‚àö should count reviews for daily missions with date filter (1 ms)
        ‚àö should count all-time reviews for narrative missions (1 ms)
        ‚àö should count reviews for weekly missions (1 ms)
      getQualityReviewCount
        ‚àö should count reviews meeting min length requirement (1 ms)
        ‚àö should handle photo requirement (Phase 3 placeholder) (2 ms)
      getReviewsMinLengthCount
        ‚àö should count reviews with minimum length (1 ms)
      getReviewsWithPhotosCount
        ‚àö should return photo count from user_photo_uploads table (2 ms)
    Utility Functions
      getThisWeekMonday
        ‚àö should return Monday 00:00:00 of current week in Bangkok timezone (1 ms)
        ‚àö should handle Sunday correctly (previous Monday) (7 ms)
    Edge Cases
      ‚àö should handle concurrent mission updates gracefully (3 ms)
      ‚àö should handle missions without count requirement (default to 1) (1 ms)
      ‚àö should handle mission completion without duplicate badge awards (2 ms)

PASS src/routes/__tests__/admin.integration.test.ts (25.308 s)
  Admin Routes Integration Tests
    Authorization Checks
      ‚àö should return 401 Unauthorized without auth token (183 ms)
      ‚àö should allow admin access to admin routes (37 ms)
      ‚óã skipped SKIPPED: Admin routes not protected - security issue
    GET /api/admin/dashboard-stats
      ‚àö should return dashboard statistics with parallel queries optimization (30 ms)
    GET /api/admin/users
      ‚àö should return list of all users (admin only) (28 ms)
    POST /api/admin/users/:id/role
      ‚àö should allow admin to update user roles (126 ms)
    GET /api/admin/audit-logs
      ‚àö should return audit trail of admin actions (28 ms)

PASS src/controllers/__tests__/authController.test.ts (22.323 s)
  AuthController
    register
      ‚àö should register a new user successfully (37 ms)
      ‚àö should register user with establishment_owner account type (6 ms)
      ‚àö should return 400 for missing required fields (3 ms)
      ‚àö should return 400 for invalid pseudonym format (4 ms)
      ‚àö should return 400 for invalid email format (4 ms)
      ‚àö should return 400 for weak password (4 ms)
      ‚àö should return 409 for duplicate email (4 ms)
      ‚àö should return 409 for duplicate pseudonym (3 ms)
      ‚àö should return 500 if JWT_SECRET is missing (5 ms)
    login
      ‚àö should login user with pseudonym successfully (5 ms)
      ‚àö should login user with email successfully (2 ms)
      ‚àö should return 400 for missing credentials (2 ms)
      ‚àö should return 401 for non-existent user (115 ms)
      ‚àö should return 401 for incorrect password (111 ms)
      ‚àö should return 500 if JWT_SECRET is missing (2 ms)
    getProfile
      ‚àö should return user profile with linked employee (3 ms)
      ‚àö should return 401 for unauthenticated request (2 ms)
      ‚àö should return 404 if user profile not found (3 ms)
    changePassword
      ‚àö should change password successfully (3 ms)
      ‚àö should return 401 for unauthenticated request (3 ms)
      ‚àö should return 400 for missing fields (2 ms)
      ‚àö should return 400 for invalid new password (2 ms)
      ‚àö should return 401 for incorrect current password (3 ms)
    logout
      ‚àö should logout successfully and clear cookie (3 ms)
      ‚àö should handle logout errors gracefully (2 ms)

PASS src/controllers/__tests__/pushController.test.ts (22.26 s)
  Push Controller
    getPublicKey
      ‚àö returns VAPID public key when push is configured (25 ms)
      ‚àö returns 503 when push is not configured (2 ms)
      ‚àö handles errors gracefully (4 ms)
    subscribe
      ‚àö creates new subscription successfully (3 ms)
      ‚àö updates existing subscription (6 ms)
      ‚àö returns 401 when user is not authenticated (3 ms)
      ‚àö returns 400 when subscription object is missing (2 ms)
      ‚àö returns 400 when subscription endpoint is missing (2 ms)
      ‚àö returns 400 when subscription keys are missing (2 ms)
      ‚àö returns 400 when p256dh key is missing (2 ms)
      ‚àö returns 400 when auth key is missing (2 ms)
      ‚àö handles database insert error (2 ms)
      ‚àö handles database update error (2 ms)
      ‚àö handles unexpected errors (2 ms)
    unsubscribe
      ‚àö unsubscribes successfully (2 ms)
      ‚àö returns 401 when user is not authenticated (2 ms)
      ‚àö returns 400 when endpoint is missing (2 ms)
      ‚àö handles database delete error (2 ms)
      ‚àö handles unexpected errors (1 ms)
    getUserSubscriptions
      ‚àö returns user subscriptions successfully (4 ms)
      ‚àö returns empty array when user has no subscriptions (1 ms)
      ‚àö returns 401 when user is not authenticated (2 ms)
      ‚àö handles database query error (2 ms)
      ‚àö handles unexpected errors (2 ms)
    getPushStatus
      ‚àö returns status when push is configured and user is subscribed (2 ms)
      ‚àö returns status when push is configured but user has no subscriptions (1 ms)
      ‚àö returns unconfigured status when push is not configured (1 ms)
      ‚àö returns 401 when user is not authenticated (1 ms)
      ‚àö handles unexpected errors (2 ms)

PASS src/services/__tests__/pushService.test.ts (22.486 s)
  PushService
    sendPushNotification
      ‚àö should send push notification successfully (26 ms)
      ‚àö should handle expired subscription (404) (3 ms)
      ‚àö should handle expired subscription (410) (5 ms)
      ‚àö should handle generic push errors (3 ms)
    sendPushToUser
      ‚àö should send push to all user devices (6 ms)
      ‚àö should return 0 if user has no subscriptions (2 ms)
      ‚àö should handle database errors (1 ms)
      ‚àö should handle partial failures (4 ms)
    sendPushToUsers
      ‚àö should send push to multiple users (6 ms)
      ‚àö should return 0 for empty user array (2 ms)
      ‚àö should handle batch processing for large groups (14 ms)
      ‚àö should handle database errors (3 ms)
    createPushPayload
      ‚àö should create push payload from notification (2 ms)
      ‚àö should handle notification without link (1 ms)
    getVapidPublicKey
      ‚àö should return VAPID public key (1 ms)
    isPushConfigured
      ‚àö should return true when VAPID keys are set (1 ms)

PASS src/services/__tests__/gamificationService.test.ts (22.462 s)
  GamificationService
    calculateLevel
      ‚àö should return level 1 for 0 XP (23 ms)
      ‚àö should return level 1 for negative XP (2 ms)
      ‚àö should calculate level 1 for 1-99 XP (3 ms)
      ‚àö should calculate level 2 for 100-199 XP (4 ms)
      ‚àö should calculate level 10 for 900-999 XP (3 ms)
      ‚àö should handle large XP values (2 ms)
    getXPForNextLevel
      ‚àö should return 100 XP for level 1 (3 ms)
      ‚àö should return 500 XP for level 5 (2 ms)
      ‚àö should return 1000 XP for level 10 (9 ms)
      ‚àö should handle large levels (1 ms)
    awardXP
      ‚àö should award XP and create new user_points record (14 ms)
      ‚àö should award XP and update existing user_points record (5 ms)
      ‚àö should throw error if userId is missing (52 ms)
      ‚àö should throw error if xpAmount is zero (1 ms)
      ‚àö should throw error if xpAmount is negative (2 ms)
      ‚àö should throw error if xpAmount is not an integer (1 ms)
      ‚àö should handle transaction creation error (1 ms)
      ‚àö should handle user_points fetch error (5 ms)
      ‚àö should handle user_points update error (3 ms)
      ‚àö should calculate level up correctly (4 ms)
    getUserPoints
      ‚àö should return user points if found (1 ms)
      ‚àö should return null if user points not found (2 ms)
      ‚àö should return null on database error (2 ms)
    resetMonthlyXP
      ‚àö should reset monthly XP for all users (2 ms)
      ‚àö should return 0 if no users have monthly XP (2 ms)
      ‚àö should throw error on database failure (2 ms)

PASS src/controllers/__tests__/uploadController.test.ts (22.939 s)
  UploadController
    uploadImages
      ‚àö should upload multiple images successfully (35 ms)
      ‚àö should return 400 if no images provided (4 ms)
      ‚àö should return 400 if more than 5 images (3 ms)
      ‚àö should handle cloudinary upload errors (2 ms)
    uploadSingleImage
      ‚àö should upload single image successfully (4 ms)
      ‚àö should return 400 if no image provided (2 ms)
      ‚àö should handle upload errors (2 ms)
    deleteImage
      ‚àö should delete image successfully (2 ms)
      ‚àö should return 400 if public_id missing (2 ms)
      ‚àö should return 400 if deletion fails (2 ms)
    uploadEstablishmentLogo
      ‚àö should upload logo successfully for admin (3 ms)
      ‚àö should return 400 if no logo provided (2 ms)
      ‚àö should return 403 if user is not admin or moderator (2 ms)
      ‚àö should allow moderator to upload logo (3 ms)
    getImageInfo
      ‚àö should return image info successfully (2 ms)
      ‚àö should return 400 if public_id missing (4 ms)
      ‚àö should handle errors when fetching image info (2 ms)

PASS src/jobs/__tests__/missionResetJobs.test.ts (22.737 s)
  Mission Reset Cron Jobs
    Cron Schedules
      ‚àö should create daily reset job with correct cron expression (29 ms)
      ‚àö should create weekly reset job with correct cron expression (3 ms)
      ‚àö should use Asia/Bangkok timezone for both jobs (4 ms)
      ‚àö should stop jobs immediately after creation (until manual start) (3 ms)
    Daily Reset Job
      ‚àö should call resetDailyMissions when daily job executes (5 ms)
      ‚àö should log error if daily reset fails (3 ms)
    Weekly Reset Job
      ‚àö should call resetWeeklyMissions when weekly job executes (4 ms)
      ‚àö should log error if weekly reset fails (2 ms)
    startMissionResetJobs
      ‚àö should start both daily and weekly jobs (4 ms)
      ‚àö should log cron schedule information (3 ms)
    stopMissionResetJobs
      ‚àö should stop both daily and weekly jobs (4 ms)
    Integration
      ‚àö should follow lifecycle: create ‚Üí stop ‚Üí start ‚Üí stop (2 ms)
      ‚àö should execute both daily and weekly callbacks independently (3 ms)
    Timezone Validation
      ‚àö should use Asia/Bangkok timezone (UTC+7) (4 ms)
      ‚àö should match missionTrackingService timezone helpers (2 ms)

  console.log
    üîç [2025-11-01T15:06:11.143Z] [DEBUG] VIP purchase authorized: Employee buying for self
    {
      "userId": "owner-user-id",
      "employeeId": "employee-123"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.error
    ‚ùå [2025-11-01T15:06:11.176Z] [ERROR] Error purchasing VIP:
    {
      "message": "supabase_1.supabase.from(...).select(...).eq(...).eq(...).gte is not a function",
      "stack": "TypeError: supabase_1.supabase.from(...).select(...).eq(...).eq(...).gte is not a function\n    at purchaseVIP (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\controllers\\vipController.ts:225:8)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)",
      "name": "TypeError"
    }

    [0m [90m 140 |[39m       } [33m:[39m error[33m;[39m
     [90m 141 |[39m
    [31m[1m>[22m[39m[90m 142 |[39m       console[33m.[39merror([36mthis[39m[33m.[39mformatMessage([32m'ERROR'[39m[33m,[39m message[33m,[39m errorData[33m,[39m options))[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 143 |[39m
     [90m 144 |[39m       [90m// Send to Sentry in production[39m
     [90m 145 |[39m       [36mif[39m ([33m![39m[36mthis[39m[33m.[39misDevelopment) {[0m

      at Logger.error (src/utils/logger.ts:142:15)
      at purchaseVIP (src/controllers/vipController.ts:368:12)

  console.log
    üîç [2025-11-01T15:06:11.235Z] [DEBUG] VIP purchase authorized: Employee buying for self
    {
      "userId": "owner-user-id",
      "employeeId": "non-existent-employee"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.error
    ‚ùå [2025-11-01T15:06:11.238Z] [ERROR] Error purchasing VIP:
    {
      "message": "supabase_1.supabase.from(...).select(...).eq is not a function",
      "stack": "TypeError: supabase_1.supabase.from(...).select(...).eq is not a function\n    at purchaseVIP (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\controllers\\vipController.ts:223:8)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)",
      "name": "TypeError"
    }

    [0m [90m 140 |[39m       } [33m:[39m error[33m;[39m
     [90m 141 |[39m
    [31m[1m>[22m[39m[90m 142 |[39m       console[33m.[39merror([36mthis[39m[33m.[39mformatMessage([32m'ERROR'[39m[33m,[39m message[33m,[39m errorData[33m,[39m options))[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 143 |[39m
     [90m 144 |[39m       [90m// Send to Sentry in production[39m
     [90m 145 |[39m       [36mif[39m ([33m![39m[36mthis[39m[33m.[39misDevelopment) {[0m

      at Logger.error (src/utils/logger.ts:142:15)
      at purchaseVIP (src/controllers/vipController.ts:368:12)

  console.error
    ‚ùå [2025-11-01T15:06:11.286Z] [ERROR] Error purchasing VIP:
    {
      "message": "supabase_1.supabase.from(...).select(...).eq is not a function",
      "stack": "TypeError: supabase_1.supabase.from(...).select(...).eq is not a function\n    at purchaseVIP (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\controllers\\vipController.ts:155:10)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\__tests__\\vip\\vipPurchase.test.ts:36:74\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:305:39\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:312:13\n    at mockConstructor (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:102:19)\n    at csrfProtection (eval at _createMockFunction (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:460:31), <anonymous>:3:60)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\__tests__\\vip\\vipPurchase.test.ts:33:7\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:305:39\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:312:13\n    at mockConstructor (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:102:19)\n    at authenticateToken (eval at _createMockFunction (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:460:31), <anonymous>:3:63)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:284:15\n    at Function.process_params (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\body-parser\\lib\\read.js:137:5\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at invokeCallback (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\raw-body\\index.js:238:16)\n    at done (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\raw-body\\index.js:227:7)\n    at IncomingMessage.onEnd (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\raw-body\\index.js:287:7)\n    at IncomingMessage.emit (node:events:518:28)\n    at endReadableNT (node:internal/streams/readable:1698:12)\n    at processTicksAndRejections (node:internal/process/task_queues:90:21)",
      "name": "TypeError"
    }

    [0m [90m 140 |[39m       } [33m:[39m error[33m;[39m
     [90m 141 |[39m
    [31m[1m>[22m[39m[90m 142 |[39m       console[33m.[39merror([36mthis[39m[33m.[39mformatMessage([32m'ERROR'[39m[33m,[39m message[33m,[39m errorData[33m,[39m options))[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 143 |[39m
     [90m 144 |[39m       [90m// Send to Sentry in production[39m
     [90m 145 |[39m       [36mif[39m ([33m![39m[36mthis[39m[33m.[39misDevelopment) {[0m

      at Logger.error (src/utils/logger.ts:142:15)
      at purchaseVIP (src/controllers/vipController.ts:368:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at src/__tests__/vip/vipPurchase.test.ts:36:74
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at src/__tests__/vip/vipPurchase.test.ts:33:7
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.error
    ‚ùå [2025-11-01T15:06:11.328Z] [ERROR] Error purchasing VIP:
    {
      "message": "supabase_1.supabase.from(...).select is not a function",
      "stack": "TypeError: supabase_1.supabase.from(...).select is not a function\n    at purchaseVIP (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\controllers\\vipController.ts:154:10)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\__tests__\\vip\\vipPurchase.test.ts:36:74\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:305:39\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:312:13\n    at mockConstructor (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:102:19)\n    at csrfProtection (eval at _createMockFunction (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:460:31), <anonymous>:3:60)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\__tests__\\vip\\vipPurchase.test.ts:33:7\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:305:39\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:312:13\n    at mockConstructor (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:102:19)\n    at authenticateToken (eval at _createMockFunction (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:460:31), <anonymous>:3:63)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:284:15\n    at Function.process_params (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\body-parser\\lib\\read.js:137:5\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at invokeCallback (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\raw-body\\index.js:238:16)\n    at done (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\raw-body\\index.js:227:7)\n    at IncomingMessage.onEnd (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\raw-body\\index.js:287:7)\n    at IncomingMessage.emit (node:events:518:28)\n    at endReadableNT (node:internal/streams/readable:1698:12)\n    at processTicksAndRejections (node:internal/process/task_queues:90:21)",
      "name": "TypeError"
    }

    [0m [90m 140 |[39m       } [33m:[39m error[33m;[39m
     [90m 141 |[39m
    [31m[1m>[22m[39m[90m 142 |[39m       console[33m.[39merror([36mthis[39m[33m.[39mformatMessage([32m'ERROR'[39m[33m,[39m message[33m,[39m errorData[33m,[39m options))[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 143 |[39m
     [90m 144 |[39m       [90m// Send to Sentry in production[39m
     [90m 145 |[39m       [36mif[39m ([33m![39m[36mthis[39m[33m.[39misDevelopment) {[0m

      at Logger.error (src/utils/logger.ts:142:15)
      at purchaseVIP (src/controllers/vipController.ts:368:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at src/__tests__/vip/vipPurchase.test.ts:36:74
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at src/__tests__/vip/vipPurchase.test.ts:33:7
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.log
    üîç [2025-11-01T15:06:11.354Z] [DEBUG] VIP purchase authorized: Employee buying for self
    {
      "userId": "owner-user-id",
      "employeeId": "employee-123"
    }

      at Logger.debug (src/utils/logger.ts:109:15)

  console.error
    ‚ùå [2025-11-01T15:06:11.358Z] [ERROR] Error purchasing VIP:
    {
      "message": "supabase_1.supabase.from(...).select(...).eq(...).eq(...).gte is not a function",
      "stack": "TypeError: supabase_1.supabase.from(...).select(...).eq(...).eq(...).gte is not a function\n    at purchaseVIP (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\controllers\\vipController.ts:225:8)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)",
      "name": "TypeError"
    }

    [0m [90m 140 |[39m       } [33m:[39m error[33m;[39m
     [90m 141 |[39m
    [31m[1m>[22m[39m[90m 142 |[39m       console[33m.[39merror([36mthis[39m[33m.[39mformatMessage([32m'ERROR'[39m[33m,[39m message[33m,[39m errorData[33m,[39m options))[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 143 |[39m
     [90m 144 |[39m       [90m// Send to Sentry in production[39m
     [90m 145 |[39m       [36mif[39m ([33m![39m[36mthis[39m[33m.[39misDevelopment) {[0m

      at Logger.error (src/utils/logger.ts:142:15)
      at purchaseVIP (src/controllers/vipController.ts:368:12)

  console.error
    ‚ùå [2025-11-01T15:06:11.392Z] [ERROR] Error purchasing VIP:
    {
      "message": "supabase_1.supabase.from(...).select(...).eq(...).eq(...).gte is not a function",
      "stack": "TypeError: supabase_1.supabase.from(...).select(...).eq(...).eq(...).gte is not a function\n    at purchaseVIP (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\controllers\\vipController.ts:225:8)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)",
      "name": "TypeError"
    }

    [0m [90m 140 |[39m       } [33m:[39m error[33m;[39m
     [90m 141 |[39m
    [31m[1m>[22m[39m[90m 142 |[39m       console[33m.[39merror([36mthis[39m[33m.[39mformatMessage([32m'ERROR'[39m[33m,[39m message[33m,[39m errorData[33m,[39m options))[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 143 |[39m
     [90m 144 |[39m       [90m// Send to Sentry in production[39m
     [90m 145 |[39m       [36mif[39m ([33m![39m[36mthis[39m[33m.[39misDevelopment) {[0m

      at Logger.error (src/utils/logger.ts:142:15)
      at purchaseVIP (src/controllers/vipController.ts:368:12)

  console.error
    ‚ùå [2025-11-01T15:06:11.407Z] [ERROR] Error purchasing VIP:
    {
      "message": "supabase_1.supabase.from(...).select is not a function",
      "stack": "TypeError: supabase_1.supabase.from(...).select is not a function\n    at purchaseVIP (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\controllers\\vipController.ts:222:8)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)",
      "name": "TypeError"
    }

    [0m [90m 140 |[39m       } [33m:[39m error[33m;[39m
     [90m 141 |[39m
    [31m[1m>[22m[39m[90m 142 |[39m       console[33m.[39merror([36mthis[39m[33m.[39mformatMessage([32m'ERROR'[39m[33m,[39m message[33m,[39m errorData[33m,[39m options))[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 143 |[39m
     [90m 144 |[39m       [90m// Send to Sentry in production[39m
     [90m 145 |[39m       [36mif[39m ([33m![39m[36mthis[39m[33m.[39misDevelopment) {[0m

      at Logger.error (src/utils/logger.ts:142:15)
      at purchaseVIP (src/controllers/vipController.ts:368:12)

  console.error
    ‚ùå [2025-11-01T15:06:11.427Z] [ERROR] Error purchasing VIP:
    {
      "message": "supabase_1.supabase.from(...).select(...).eq is not a function",
      "stack": "TypeError: supabase_1.supabase.from(...).select(...).eq is not a function\n    at purchaseVIP (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\controllers\\vipController.ts:155:10)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\__tests__\\vip\\vipPurchase.test.ts:36:74\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:305:39\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:312:13\n    at mockConstructor (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:102:19)\n    at csrfProtection (eval at _createMockFunction (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:460:31), <anonymous>:3:60)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\__tests__\\vip\\vipPurchase.test.ts:33:7\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:305:39\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:312:13\n    at mockConstructor (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:102:19)\n    at authenticateToken (eval at _createMockFunction (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:460:31), <anonymous>:3:63)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:284:15\n    at Function.process_params (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\body-parser\\lib\\read.js:137:5\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at invokeCallback (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\raw-body\\index.js:238:16)\n    at done (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\raw-body\\index.js:227:7)\n    at IncomingMessage.onEnd (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\raw-body\\index.js:287:7)\n    at IncomingMessage.emit (node:events:518:28)\n    at endReadableNT (node:internal/streams/readable:1698:12)\n    at processTicksAndRejections (node:internal/process/task_queues:90:21)",
      "name": "TypeError"
    }

    [0m [90m 140 |[39m       } [33m:[39m error[33m;[39m
     [90m 141 |[39m
    [31m[1m>[22m[39m[90m 142 |[39m       console[33m.[39merror([36mthis[39m[33m.[39mformatMessage([32m'ERROR'[39m[33m,[39m message[33m,[39m errorData[33m,[39m options))[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 143 |[39m
     [90m 144 |[39m       [90m// Send to Sentry in production[39m
     [90m 145 |[39m       [36mif[39m ([33m![39m[36mthis[39m[33m.[39misDevelopment) {[0m

      at Logger.error (src/utils/logger.ts:142:15)
      at purchaseVIP (src/controllers/vipController.ts:368:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at src/__tests__/vip/vipPurchase.test.ts:36:74
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at src/__tests__/vip/vipPurchase.test.ts:33:7
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.warn
    ‚ö†Ô∏è [2025-11-01T15:06:11.238Z] [WARN] ‚ö†Ô∏è VAPID keys not configured. Push notifications will not work.

    [0m [90m 125 |[39m   warn(message[33m:[39m string[33m,[39m data[33m?[39m[33m:[39m any[33m,[39m options[33m?[39m[33m:[39m [33mLogOptions[39m) {
     [90m 126 |[39m     [36mif[39m ([36mthis[39m[33m.[39mminLevel [33m<=[39m [33mLogLevel[39m[33m.[39m[33mWARN[39m) {
    [31m[1m>[22m[39m[90m 127 |[39m       console[33m.[39mwarn([36mthis[39m[33m.[39mformatMessage([32m'WARN'[39m[33m,[39m message[33m,[39m data[33m,[39m options))[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 128 |[39m     }
     [90m 129 |[39m   }
     [90m 130 |[39m[0m

      at Logger.warn (src/utils/logger.ts:127:15)
      at Object.<anonymous> (src/services/pushService.ts:24:10)
      at Object.<anonymous> (src/utils/notificationHelper.ts:4:1)
      at Object.<anonymous> (src/controllers/vipController.ts:25:1)
      at Object.<anonymous> (src/__tests__/vip/vipVerification.test.ts:12:1)

  console.warn
    ‚ö†Ô∏è [2025-11-01T15:06:11.454Z] [WARN] Generate keys with: npx web-push generate-vapid-keys

    [0m [90m 125 |[39m   warn(message[33m:[39m string[33m,[39m data[33m?[39m[33m:[39m any[33m,[39m options[33m?[39m[33m:[39m [33mLogOptions[39m) {
     [90m 126 |[39m     [36mif[39m ([36mthis[39m[33m.[39mminLevel [33m<=[39m [33mLogLevel[39m[33m.[39m[33mWARN[39m) {
    [31m[1m>[22m[39m[90m 127 |[39m       console[33m.[39mwarn([36mthis[39m[33m.[39mformatMessage([32m'WARN'[39m[33m,[39m message[33m,[39m data[33m,[39m options))[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 128 |[39m     }
     [90m 129 |[39m   }
     [90m 130 |[39m[0m

      at Logger.warn (src/utils/logger.ts:127:15)
      at Object.<anonymous> (src/services/pushService.ts:25:10)
      at Object.<anonymous> (src/utils/notificationHelper.ts:4:1)
      at Object.<anonymous> (src/controllers/vipController.ts:25:1)
      at Object.<anonymous> (src/__tests__/vip/vipVerification.test.ts:12:1)

  console.error
    ‚ùå [2025-11-01T15:06:11.474Z] [ERROR] Error purchasing VIP:
    {
      "message": "supabase_1.supabase.from(...).select is not a function",
      "stack": "TypeError: supabase_1.supabase.from(...).select is not a function\n    at purchaseVIP (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\controllers\\vipController.ts:154:10)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\__tests__\\vip\\vipPurchase.test.ts:36:74\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:305:39\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:312:13\n    at mockConstructor (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:102:19)\n    at csrfProtection (eval at _createMockFunction (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:460:31), <anonymous>:3:60)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\__tests__\\vip\\vipPurchase.test.ts:33:7\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:305:39\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:312:13\n    at mockConstructor (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:102:19)\n    at authenticateToken (eval at _createMockFunction (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:460:31), <anonymous>:3:63)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:284:15\n    at Function.process_params (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\body-parser\\lib\\read.js:137:5\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at invokeCallback (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\raw-body\\index.js:238:16)\n    at done (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\raw-body\\index.js:227:7)\n    at IncomingMessage.onEnd (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\raw-body\\index.js:287:7)\n    at IncomingMessage.emit (node:events:518:28)\n    at endReadableNT (node:internal/streams/readable:1698:12)\n    at processTicksAndRejections (node:internal/process/task_queues:90:21)",
      "name": "TypeError"
    }

    [0m [90m 140 |[39m       } [33m:[39m error[33m;[39m
     [90m 141 |[39m
    [31m[1m>[22m[39m[90m 142 |[39m       console[33m.[39merror([36mthis[39m[33m.[39mformatMessage([32m'ERROR'[39m[33m,[39m message[33m,[39m errorData[33m,[39m options))[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 143 |[39m
     [90m 144 |[39m       [90m// Send to Sentry in production[39m
     [90m 145 |[39m       [36mif[39m ([33m![39m[36mthis[39m[33m.[39misDevelopment) {[0m

      at Logger.error (src/utils/logger.ts:142:15)
      at purchaseVIP (src/controllers/vipController.ts:368:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at src/__tests__/vip/vipPurchase.test.ts:36:74
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at src/__tests__/vip/vipPurchase.test.ts:33:7
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

PASS src/routes/__tests__/notifications.integration.test.ts (26.037 s)
  Notification Routes Integration Tests
    GET /api/notifications
      ‚àö should return user notifications with authentication (154 ms)
      ‚àö should filter unread notifications when unread_only=true (15 ms)
      ‚àö should apply custom limit parameter (19 ms)
      ‚àö should return 401 without authentication (17 ms)
    GET /api/notifications/unread-count
      ‚àö should return unread notification count with authentication (21 ms)
      ‚àö should return 0 when user has no unread notifications (14 ms)
      ‚àö should return 401 without authentication (15 ms)
    PATCH /api/notifications/:id/read
      ‚àö should mark notification as read with authentication (19 ms)
      ‚àö should return 404 when notification not found or belongs to another user (29 ms)
      ‚àö should return 401 without authentication (15 ms)
    PATCH /api/notifications/mark-all-read
      ‚àö should mark all notifications as read with authentication (15 ms)
      ‚àö should succeed even when user has no notifications (13 ms)
      ‚àö should return 401 without authentication (7 ms)
    DELETE /api/notifications/:id
      ‚àö should delete notification with authentication (11 ms)
      ‚àö should succeed even if notification does not exist (idempotent) (8 ms)
      ‚àö should return 401 without authentication (7 ms)
    Database Error Handling
      ‚àö should handle database errors gracefully for GET /api/notifications (8 ms)
      ‚àö should handle database errors gracefully for PATCH mark-all-read (8 ms)
    Complete Notification Flow
      ‚àö should complete: Fetch notifications ‚Üí Mark one as read ‚Üí Mark all as read ‚Üí Delete one (31 ms)

PASS src/__tests__/vip/vipController.test.ts (25.083 s)
  VIP Controller Tests
    GET /api/vip/pricing/:type
      ‚àö should return employee pricing successfully (119 ms)
      ‚àö should return establishment pricing successfully (15 ms)
      ‚àö should return 400 for invalid subscription type (13 ms)
      ‚àö should include discount information for longer durations (12 ms)
      ‚àö should mark 30-day duration as popular (19 ms)
    POST /api/vip/purchase
      ‚àö should create VIP subscription successfully (71 ms)
      ‚àö should return 400 for missing required fields (10 ms)
      ‚àö should return 400 for invalid duration (9 ms)
      ‚àö should return 400 for invalid payment method (14 ms)
      ‚àö should calculate correct price based on duration (13 ms)
      ‚àö should set status to pending_payment for cash payment (11 ms)
    GET /api/vip/my-subscriptions
      ‚àö should return user subscriptions successfully (13 ms)
      ‚àö should return empty arrays if user has no subscriptions (13 ms)
    PATCH /api/vip/subscriptions/:id/cancel
      ‚àö should cancel subscription successfully (11 ms)
      ‚àö should return 404 for non-existent subscription (8 ms)
      ‚àö should return 403 if user tries to cancel someone else subscription (10 ms)
      ‚àö should return 400 if subscription is already cancelled (15 ms)

FAIL src/__tests__/vip/vipPurchase.test.ts (26.191 s)
  VIP Purchase Workflow Tests
    Employee VIP Purchase
      √ó should purchase VIP for employee successfully (cash payment) (266 ms)
      √ó should return 404 if employee does not exist (37 ms)
      √ó should return 403 if user is not owner of establishment (65 ms)
      √ó should calculate correct price for 7-day duration (22 ms)
      √ó should calculate correct price for 365-day duration with 50% discount (31 ms)
    Establishment VIP Purchase
      √ó should purchase VIP for establishment successfully (12 ms)
      √ó should return 404 if establishment does not exist (13 ms)
      √ó should calculate establishment pricing correctly (4x employee pricing) (14 ms)
    Payment Method Handling
      √ó should accept cash payment method (26 ms)
      ‚àö should reject unsupported payment methods (21 ms)
      √ó should accept promptpay payment method (when implemented) (32 ms)

  ‚óè VIP Purchase Workflow Tests ‚Ä∫ Employee VIP Purchase ‚Ä∫ should purchase VIP for employee successfully (cash payment)

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 133 |[39m           payment_method[33m:[39m [32m'cash'[39m
     [90m 134 |[39m         })
    [31m[1m>[22m[39m[90m 135 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 136 |[39m
     [90m 137 |[39m       expect(response[33m.[39mbody)[33m.[39mtoHaveProperty([32m'success'[39m[33m,[39m [36mtrue[39m)[33m;[39m
     [90m 138 |[39m       expect(response[33m.[39mbody)[33m.[39mtoHaveProperty([32m'subscription'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipPurchase.test.ts:135:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Purchase Workflow Tests ‚Ä∫ Employee VIP Purchase ‚Ä∫ should return 404 if employee does not exist

    expected 404 "Not Found", got 500 "Internal Server Error"

    [0m [90m 157 |[39m           payment_method[33m:[39m [32m'cash'[39m
     [90m 158 |[39m         })
    [31m[1m>[22m[39m[90m 159 |[39m         [33m.[39mexpect([35m404[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 160 |[39m
     [90m 161 |[39m       expect(response[33m.[39mbody)[33m.[39mtoHaveProperty([32m'error'[39m)[33m;[39m
     [90m 162 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoContain([32m'Employee not found'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipPurchase.test.ts:159:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Purchase Workflow Tests ‚Ä∫ Employee VIP Purchase ‚Ä∫ should return 403 if user is not owner of establishment

    expected 403 "Forbidden", got 500 "Internal Server Error"

    [0m [90m 204 |[39m           payment_method[33m:[39m [32m'cash'[39m
     [90m 205 |[39m         })
    [31m[1m>[22m[39m[90m 206 |[39m         [33m.[39mexpect([35m403[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 207 |[39m
     [90m 208 |[39m       expect(response[33m.[39mbody)[33m.[39mtoHaveProperty([32m'error'[39m)[33m;[39m
     [90m 209 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoContain([32m'Permission denied'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipPurchase.test.ts:206:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Purchase Workflow Tests ‚Ä∫ Employee VIP Purchase ‚Ä∫ should calculate correct price for 7-day duration

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 274 |[39m           payment_method[33m:[39m [32m'cash'[39m
     [90m 275 |[39m         })
    [31m[1m>[22m[39m[90m 276 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 277 |[39m
     [90m 278 |[39m       [90m// Verify price: 7 days = 1000 THB[39m
     [90m 279 |[39m       expect(capturedTransaction[33m.[39mamount)[33m.[39mtoBe([35m1000[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipPurchase.test.ts:276:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Purchase Workflow Tests ‚Ä∫ Employee VIP Purchase ‚Ä∫ should calculate correct price for 365-day duration with 50% discount

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 344 |[39m           payment_method[33m:[39m [32m'cash'[39m
     [90m 345 |[39m         })
    [31m[1m>[22m[39m[90m 346 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 347 |[39m
     [90m 348 |[39m       [90m// Verify price: 365 days = 18250 THB (50% discount from ~36500)[39m
     [90m 349 |[39m       expect(capturedTransaction[33m.[39mamount)[33m.[39mtoBe([35m18250[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipPurchase.test.ts:346:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Purchase Workflow Tests ‚Ä∫ Establishment VIP Purchase ‚Ä∫ should purchase VIP for establishment successfully

    expected 200 "OK", got 403 "Forbidden"

    [0m [90m 412 |[39m           payment_method[33m:[39m [32m'cash'[39m
     [90m 413 |[39m         })
    [31m[1m>[22m[39m[90m 414 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 415 |[39m
     [90m 416 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 417 |[39m       expect(response[33m.[39mbody[33m.[39msubscription[33m.[39mtier)[33m.[39mtoBe([32m'establishment'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipPurchase.test.ts:414:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Purchase Workflow Tests ‚Ä∫ Establishment VIP Purchase ‚Ä∫ should return 404 if establishment does not exist

    expected 404 "Not Found", got 500 "Internal Server Error"

    [0m [90m 433 |[39m           payment_method[33m:[39m [32m'cash'[39m
     [90m 434 |[39m         })
    [31m[1m>[22m[39m[90m 435 |[39m         [33m.[39mexpect([35m404[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 436 |[39m
     [90m 437 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoContain([32m'Establishment not found'[39m)[33m;[39m
     [90m 438 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipPurchase.test.ts:435:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Purchase Workflow Tests ‚Ä∫ Establishment VIP Purchase ‚Ä∫ should calculate establishment pricing correctly (4x employee pricing)

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 491 |[39m           payment_method[33m:[39m [32m'cash'[39m
     [90m 492 |[39m         })
    [31m[1m>[22m[39m[90m 493 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 494 |[39m
     [90m 495 |[39m       [90m// Establishment 7-day = 3000 THB (vs employee 1000 THB)[39m
     [90m 496 |[39m       expect(capturedTransaction[33m.[39mamount)[33m.[39mtoBe([35m3000[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipPurchase.test.ts:493:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Purchase Workflow Tests ‚Ä∫ Payment Method Handling ‚Ä∫ should accept cash payment method

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 562 |[39m           payment_method[33m:[39m [32m'cash'[39m
     [90m 563 |[39m         })
    [31m[1m>[22m[39m[90m 564 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 565 |[39m
     [90m 566 |[39m       expect(capturedTransaction[33m.[39mpayment_method)[33m.[39mtoBe([32m'cash'[39m)[33m;[39m
     [90m 567 |[39m       expect(capturedTransaction[33m.[39mpayment_status)[33m.[39mtoBe([32m'pending'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipPurchase.test.ts:564:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Purchase Workflow Tests ‚Ä∫ Payment Method Handling ‚Ä∫ should accept promptpay payment method (when implemented)

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [400, 501]

    [0m [90m 594 |[39m
     [90m 595 |[39m       [90m// For now, should return 400 or 501 (Not Implemented)[39m
    [31m[1m>[22m[39m[90m 596 |[39m       expect([[35m400[39m[33m,[39m [35m501[39m])[33m.[39mtoContain(response[33m.[39mstatus)[33m;[39m
     [90m     |[39m                          [31m[1m^[22m[39m
     [90m 597 |[39m     })[33m;[39m
     [90m 598 |[39m   })[33m;[39m
     [90m 599 |[39m })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipPurchase.test.ts:596:26)

PASS src/middleware/__tests__/auth.test.ts (24.932 s)
  Authentication Middleware
    authenticateToken
      ‚àö should authenticate valid token from cookie (18 ms)
      ‚àö should authenticate valid token from Authorization header (2 ms)
      ‚àö should reject request with no token (3 ms)
      ‚àö should reject invalid token (2 ms)
      ‚àö should reject token with missing payload fields (2 ms)
      ‚àö should reject token for inactive user (2 ms)
      ‚àö should reject token with mismatched claims (1 ms)
      ‚àö should handle missing JWT_SECRET (1 ms)
      ‚óã skipped should reject expired token
    requireRole
      ‚àö should allow access for user with correct role (1 ms)
      ‚àö should deny access for user with incorrect role (2 ms)
      ‚àö should deny access for unauthenticated user (1 ms)
      ‚àö should deny access for inactive user (1 ms)
      ‚àö should handle invalid roles configuration (1 ms)
    requireAdmin
      ‚àö should allow access for admin user (1 ms)
      ‚àö should deny access for non-admin user (2 ms)
    requireModerator
      ‚àö should allow access for moderator
      ‚àö should allow access for admin (9 ms)
      ‚àö should deny access for regular user (1 ms)

PASS src/controllers/__tests__/establishmentController.test.ts (25.199 s)
  EstablishmentController
    getEstablishments
      ‚àö should return list of establishments with pagination (25 ms)
      ‚àö should filter establishments by zone (5 ms)
      ‚àö should filter establishments by category (4 ms)
      ‚àö should return 400 for invalid status parameter (2 ms)
      ‚àö should return 400 for invalid limit parameter (9 ms)
      ‚àö should search establishments by name (3 ms)
    getEstablishment
      ‚àö should return establishment by ID (3 ms)
      ‚àö should return 404 for non-existent establishment (2 ms)
    createEstablishment
      ‚àö should create establishment as admin (auto-approved) (4 ms)
      ‚àö should create establishment as user (pending approval) (2 ms)
      ‚àö should return 400 for missing required fields (2 ms)
      ‚àö should handle database errors (1 ms)
    updateEstablishment
      ‚àö should allow admin to update any establishment (4 ms)
      ‚àö should allow creator to update own establishment (2 ms)
      ‚àö should deny update for non-owner non-admin user (1 ms)
      ‚àö should return 404 for non-existent establishment (2 ms)
    deleteEstablishment
      ‚àö should allow admin to delete any establishment (1 ms)
      ‚àö should allow creator to delete own establishment (1 ms)
      ‚àö should deny delete for non-owner non-admin user (3 ms)
      ‚àö should return 404 for non-existent establishment (1 ms)
    updateEstablishmentGridPosition
      ‚àö should update grid position for admin (3 ms)
      ‚àö should deny grid position update for non-admin (1 ms)
      ‚àö should return 400 for missing required fields (2 ms)
      ‚àö should return 400 for invalid grid position bounds (1 ms)
      ‚àö should return 409 when position is occupied (without swap) (2 ms)
      ‚àö should return 404 for non-existent establishment (1 ms)

FAIL src/routes/__tests__/admin.complete.test.ts (26.919 s)
  üß™ Admin Routes - Comprehensive Test Suite
    üîí Authorization
      ‚àö should return 401 without auth token (184 ms)
      √ó should return 403 for non-admin users (45 ms)
      ‚àö should allow admin access (20 ms)
    üè¢ Establishments
      GET /establishments
        ‚àö should return list of establishments (18 ms)
        ‚àö should filter by status (20 ms)
        ‚àö should handle database errors (15 ms)
      PUT /establishments/:id
        ‚àö should update establishment (57 ms)
        ‚àö should return 404 for non-existent (19 ms)
        √ó should reject invalid fields with 400 (24 ms)
      POST /establishments/:id/approve
        ‚àö should approve establishment (18 ms)
        ‚àö should return 404 for non-existent (14 ms)
        √ó should send notification (194 ms)
      POST /establishments/:id/reject
        ‚àö should reject with reason (15 ms)
        √ó should send rejection notification (14 ms)
        √ó should require rejection reason (14 ms)
      DELETE /establishments/:id
        √ó should delete establishment (18 ms)
        √ó should handle cascade deletion (16 ms)
        √ó should handle DB errors (14 ms)
    üë• Employees
      GET /employees
        ‚àö should return list of employees (14 ms)
        ‚àö should filter by status (14 ms)
        ‚àö should handle errors (18 ms)
      PUT /employees/:id
        ‚àö should update employee (14 ms)
        ‚àö should return 404 for non-existent (14 ms)
        √ó should reject invalid fields with 400 (15 ms)
      POST /employees/:id/approve
        ‚àö should approve employee (13 ms)
        √ó should return 404 for non-existent (12 ms)
        √ó should send notification (12 ms)
      POST /employees/:id/reject
        ‚àö should reject with reason (19 ms)
        √ó should send rejection notification (15 ms)
        √ó should require rejection reason (14 ms)
    üë§ Users
      GET /users
        ‚àö should return list of users (17 ms)
        ‚àö should filter by role (14 ms)
        ‚àö should handle errors (15 ms)
      PUT /users/:id
        ‚àö should update user (18 ms)
        √ó should return 404 for non-existent (15 ms)
        √ó should reject invalid fields with 400 (14 ms)
      POST /users/:id/role
        ‚àö should update user role (17 ms)
        ‚àö should validate role value (12 ms)
        √ó should return 404 for non-existent user (15 ms)
      POST /users/:id/toggle-active
        ‚àö should toggle user active status (19 ms)
        √ó should return 404 for non-existent user (18 ms)
        √ó should handle DB errors (16 ms)
    üìä Stats
      GET /dashboard-stats
        ‚àö should return dashboard statistics (23 ms)
        ‚àö should use Promise.all optimization (13 ms)
        ‚àö should handle partial failures gracefully (12 ms)
      GET /user-stats/:id
        ‚àö should return user statistics (16 ms)
        √ó should return 404 for non-existent user (15 ms)
        √ó should handle invalid user ID (15 ms)
    üí¨ Comments
      GET /comments
        ‚àö should return list of comments (14 ms)
        ‚àö should filter by status (13 ms)
        ‚àö should handle errors (14 ms)
      POST /comments/:id/approve
        ‚àö should approve comment (14 ms)
        √ó should return 404 for non-existent (17 ms)
        ‚àö should clear reports on approval (16 ms)
      POST /comments/:id/reject
        ‚àö should reject comment (13 ms)
        √ó should return 404 for non-existent (14 ms)
        ‚àö should resolve reports on rejection (13 ms)
      POST /comments/:id/dismiss-reports
        ‚àö should dismiss reports (23 ms)
        √ó should return 404 for non-existent comment (13 ms)
        ‚àö should handle DB errors (15 ms)
    üçπ Consumables
      GET /consumables
        ‚àö should return list of consumables (13 ms)
        ‚àö should order by category and name (17 ms)
        ‚àö should handle DB errors (13 ms)
      POST /consumables
        ‚àö should create consumable (14 ms)
        ‚àö should set status to active by default (20 ms)
        ‚àö should handle DB errors (14 ms)
      PUT /consumables/:id
        ‚àö should update consumable (18 ms)
        ‚àö should return 500 for non-existent consumable (13 ms)
        ‚àö should filter out non-modifiable fields (13 ms)
      DELETE /consumables/:id
        ‚àö should delete consumable (20 ms)
        ‚àö should handle cascade deletion (26 ms)
        ‚àö should handle DB errors (13 ms)
      PUT /consumables/:id/status
        ‚àö should update consumable status (14 ms)
        ‚àö should return 500 for non-existent consumable (16 ms)
        ‚àö should handle DB errors (13 ms)
      GET /establishments/:id/consumables
        ‚àö should return establishment menu (18 ms)
        ‚àö should include consumable template data (13 ms)
        ‚àö should handle DB errors (13 ms)
      POST /establishments/:id/consumables
        ‚àö should add consumable to establishment (17 ms)
        ‚àö should default is_available to true (17 ms)
        ‚àö should handle DB errors (14 ms)
      PUT /establishments/:establishment_id/consumables/:consumable_id
        ‚àö should update establishment consumable (13 ms)
        ‚àö should toggle availability (13 ms)
        ‚àö should handle DB errors (13 ms)
      DELETE /establishments/:establishment_id/consumables/:consumable_id
        ‚àö should remove consumable from establishment (13 ms)
        ‚àö should not delete consumable template (13 ms)
        ‚àö should handle DB errors (12 ms)

  ‚óè üß™ Admin Routes - Comprehensive Test Suite ‚Ä∫ üîí Authorization ‚Ä∫ should return 403 for non-admin users

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 200

    [0m [90m 168 |[39m         [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${userToken}`[39m])[33m;[39m
     [90m 169 |[39m
    [31m[1m>[22m[39m[90m 170 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m403[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 171 |[39m       expect(response[33m.[39mbody[33m.[39mcode)[33m.[39mtoBe([32m'INSUFFICIENT_ROLE'[39m)[33m;[39m
     [90m 172 |[39m     })[33m;[39m
     [90m 173 |[39m[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:170:31)

  ‚óè üß™ Admin Routes - Comprehensive Test Suite ‚Ä∫ üè¢ Establishments ‚Ä∫ PUT /establishments/:id ‚Ä∫ should reject invalid fields with 400

    expected 400 "Bad Request", got 500 "Internal Server Error"

    [0m [90m 316 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
     [90m 317 |[39m           [33m.[39msend({ invalid_field[33m:[39m [32m'value'[39m })
    [31m[1m>[22m[39m[90m 318 |[39m           [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m            [31m[1m^[22m[39m
     [90m 319 |[39m
     [90m 320 |[39m         expect(response[33m.[39mbody[33m.[39mcode)[33m.[39mtoBe([32m'INVALID_FIELDS'[39m)[33m;[39m
     [90m 321 |[39m         expect(response[33m.[39mbody[33m.[39minvalidFields)[33m.[39mtoEqual([[32m'invalid_field'[39m])[33m;[39m[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:318:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè üß™ Admin Routes - Comprehensive Test Suite ‚Ä∫ üè¢ Establishments ‚Ä∫ POST /establishments/:id/approve ‚Ä∫ should send notification

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

    [0m [90m 383 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])[33m;[39m
     [90m 384 |[39m
    [31m[1m>[22m[39m[90m 385 |[39m         expect(mockNotify)[33m.[39mtoHaveBeenCalled()[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 386 |[39m       })[33m;[39m
     [90m 387 |[39m     })[33m;[39m
     [90m 388 |[39m[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:385:28)

  ‚óè üß™ Admin Routes - Comprehensive Test Suite ‚Ä∫ üè¢ Establishments ‚Ä∫ POST /establishments/:id/reject ‚Ä∫ should send rejection notification

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

    [0m [90m 433 |[39m           [33m.[39msend({ reason[33m:[39m [32m'Test'[39m })[33m;[39m
     [90m 434 |[39m
    [31m[1m>[22m[39m[90m 435 |[39m         expect(mockNotify)[33m.[39mtoHaveBeenCalled()[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 436 |[39m       })[33m;[39m
     [90m 437 |[39m
     [90m 438 |[39m       it([32m'should require rejection reason'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:435:28)

  ‚óè üß™ Admin Routes - Comprehensive Test Suite ‚Ä∫ üè¢ Establishments ‚Ä∫ POST /establishments/:id/reject ‚Ä∫ should require rejection reason

    expected 400 "Bad Request", got 500 "Internal Server Error"

    [0m [90m 444 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
     [90m 445 |[39m           [33m.[39msend({})
    [31m[1m>[22m[39m[90m 446 |[39m           [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m            [31m[1m^[22m[39m
     [90m 447 |[39m
     [90m 448 |[39m         expect(response[33m.[39mbody[33m.[39mcode)[33m.[39mtoBe([32m'REASON_REQUIRED'[39m)[33m;[39m
     [90m 449 |[39m         expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoContain([32m'Rejection reason is required'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:446:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè üß™ Admin Routes - Comprehensive Test Suite ‚Ä∫ üè¢ Establishments ‚Ä∫ DELETE /establishments/:id ‚Ä∫ should delete establishment

    expected 200 "OK", got 404 "Not Found"

    [0m [90m 469 |[39m           [33m.[39m[36mdelete[39m([32m'/api/admin/establishments/aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa'[39m)
     [90m 470 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
    [31m[1m>[22m[39m[90m 471 |[39m           [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m            [31m[1m^[22m[39m
     [90m 472 |[39m       })[33m;[39m
     [90m 473 |[39m
     [90m 474 |[39m       it([32m'should handle cascade deletion'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:471:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè üß™ Admin Routes - Comprehensive Test Suite ‚Ä∫ üè¢ Establishments ‚Ä∫ DELETE /establishments/:id ‚Ä∫ should handle cascade deletion

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "establishments"
    Received: "users"

    Number of calls: 1

    [0m [90m 490 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])[33m;[39m
     [90m 491 |[39m
    [31m[1m>[22m[39m[90m 492 |[39m         expect(supabase[33m.[39m[36mfrom[39m)[33m.[39mtoHaveBeenCalledWith([32m'establishments'[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 493 |[39m       })[33m;[39m
     [90m 494 |[39m
     [90m 495 |[39m       it([32m'should handle DB errors'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:492:31)

  ‚óè üß™ Admin Routes - Comprehensive Test Suite ‚Ä∫ üè¢ Establishments ‚Ä∫ DELETE /establishments/:id ‚Ä∫ should handle DB errors

    expected 500 "Internal Server Error", got 404 "Not Found"

    [0m [90m 510 |[39m           [33m.[39m[36mdelete[39m([32m'/api/admin/establishments/aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa'[39m)
     [90m 511 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
    [31m[1m>[22m[39m[90m 512 |[39m           [33m.[39mexpect([35m500[39m)[33m;[39m
     [90m     |[39m            [31m[1m^[22m[39m
     [90m 513 |[39m       })[33m;[39m
     [90m 514 |[39m     })[33m;[39m
     [90m 515 |[39m   })[33m;[39m[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:512:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè üß™ Admin Routes - Comprehensive Test Suite ‚Ä∫ üë• Employees ‚Ä∫ PUT /employees/:id ‚Ä∫ should reject invalid fields with 400

    expected 400 "Bad Request", got 500 "Internal Server Error"

    [0m [90m 613 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
     [90m 614 |[39m           [33m.[39msend({ invalid_field[33m:[39m [32m'value'[39m })
    [31m[1m>[22m[39m[90m 615 |[39m           [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m            [31m[1m^[22m[39m
     [90m 616 |[39m
     [90m 617 |[39m         expect(response[33m.[39mbody[33m.[39mcode)[33m.[39mtoBe([32m'INVALID_FIELDS'[39m)[33m;[39m
     [90m 618 |[39m         expect(response[33m.[39mbody[33m.[39minvalidFields)[33m.[39mtoEqual([[32m'invalid_field'[39m])[33m;[39m[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:615:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè üß™ Admin Routes - Comprehensive Test Suite ‚Ä∫ üë• Employees ‚Ä∫ POST /employees/:id/approve ‚Ä∫ should return 404 for non-existent

    expected 404 "Not Found", got 500 "Internal Server Error"

    [0m [90m 652 |[39m           [33m.[39mpost([32m'/api/admin/employees/non-existent/approve'[39m)
     [90m 653 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
    [31m[1m>[22m[39m[90m 654 |[39m           [33m.[39mexpect([35m404[39m)[33m;[39m
     [90m     |[39m            [31m[1m^[22m[39m
     [90m 655 |[39m       })[33m;[39m
     [90m 656 |[39m
     [90m 657 |[39m       it([32m'should send notification'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:654:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè üß™ Admin Routes - Comprehensive Test Suite ‚Ä∫ üë• Employees ‚Ä∫ POST /employees/:id/approve ‚Ä∫ should send notification

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

    [0m [90m 676 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])[33m;[39m
     [90m 677 |[39m
    [31m[1m>[22m[39m[90m 678 |[39m         expect(mockNotify)[33m.[39mtoHaveBeenCalled()[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 679 |[39m       })[33m;[39m
     [90m 680 |[39m     })[33m;[39m
     [90m 681 |[39m[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:678:28)

  ‚óè üß™ Admin Routes - Comprehensive Test Suite ‚Ä∫ üë• Employees ‚Ä∫ POST /employees/:id/reject ‚Ä∫ should send rejection notification

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

    [0m [90m 723 |[39m           [33m.[39msend({ reason[33m:[39m [32m'Test'[39m })[33m;[39m
     [90m 724 |[39m
    [31m[1m>[22m[39m[90m 725 |[39m         expect(mockNotify)[33m.[39mtoHaveBeenCalled()[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 726 |[39m       })[33m;[39m
     [90m 727 |[39m
     [90m 728 |[39m       it([32m'should require rejection reason'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:725:28)

  ‚óè üß™ Admin Routes - Comprehensive Test Suite ‚Ä∫ üë• Employees ‚Ä∫ POST /employees/:id/reject ‚Ä∫ should require rejection reason

    expected 400 "Bad Request", got 500 "Internal Server Error"

    [0m [90m 734 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
     [90m 735 |[39m           [33m.[39msend({})
    [31m[1m>[22m[39m[90m 736 |[39m           [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m            [31m[1m^[22m[39m
     [90m 737 |[39m
     [90m 738 |[39m         expect(response[33m.[39mbody[33m.[39mcode)[33m.[39mtoBe([32m'REASON_REQUIRED'[39m)[33m;[39m
     [90m 739 |[39m         expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoContain([32m'Rejection reason is required'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:736:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè üß™ Admin Routes - Comprehensive Test Suite ‚Ä∫ üë§ Users ‚Ä∫ PUT /users/:id ‚Ä∫ should return 404 for non-existent

    expected 404 "Not Found", got 500 "Internal Server Error"

    [0m [90m 837 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
     [90m 838 |[39m           [33m.[39msend({ pseudonym[33m:[39m [32m'new'[39m })
    [31m[1m>[22m[39m[90m 839 |[39m           [33m.[39mexpect([35m404[39m)[33m;[39m
     [90m     |[39m            [31m[1m^[22m[39m
     [90m 840 |[39m       })[33m;[39m
     [90m 841 |[39m
     [90m 842 |[39m       it([32m'should reject invalid fields with 400'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:839:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè üß™ Admin Routes - Comprehensive Test Suite ‚Ä∫ üë§ Users ‚Ä∫ PUT /users/:id ‚Ä∫ should reject invalid fields with 400

    expected 400 "Bad Request", got 500 "Internal Server Error"

    [0m [90m 871 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
     [90m 872 |[39m           [33m.[39msend({ invalid_field[33m:[39m [32m'value'[39m })
    [31m[1m>[22m[39m[90m 873 |[39m           [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m            [31m[1m^[22m[39m
     [90m 874 |[39m
     [90m 875 |[39m         expect(response[33m.[39mbody[33m.[39mcode)[33m.[39mtoBe([32m'INVALID_FIELDS'[39m)[33m;[39m
     [90m 876 |[39m         expect(response[33m.[39mbody[33m.[39minvalidFields)[33m.[39mtoEqual([[32m'invalid_field'[39m])[33m;[39m[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:873:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè üß™ Admin Routes - Comprehensive Test Suite ‚Ä∫ üë§ Users ‚Ä∫ POST /users/:id/role ‚Ä∫ should return 404 for non-existent user

    expected 404 "Not Found", got 500 "Internal Server Error"

    [0m [90m 921 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
     [90m 922 |[39m           [33m.[39msend({ role[33m:[39m [32m'moderator'[39m })
    [31m[1m>[22m[39m[90m 923 |[39m           [33m.[39mexpect([35m404[39m)[33m;[39m
     [90m     |[39m            [31m[1m^[22m[39m
     [90m 924 |[39m       })[33m;[39m
     [90m 925 |[39m     })[33m;[39m
     [90m 926 |[39m[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:923:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè üß™ Admin Routes - Comprehensive Test Suite ‚Ä∫ üë§ Users ‚Ä∫ POST /users/:id/toggle-active ‚Ä∫ should return 404 for non-existent user

    expected 404 "Not Found", got 500 "Internal Server Error"

    [0m [90m 960 |[39m           [33m.[39mpost([32m'/api/admin/users/ffffffff-ffff-ffff-ffff-ffffffffffff/toggle-active'[39m)
     [90m 961 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
    [31m[1m>[22m[39m[90m 962 |[39m           [33m.[39mexpect([35m404[39m)[33m;[39m
     [90m     |[39m            [31m[1m^[22m[39m
     [90m 963 |[39m       })[33m;[39m
     [90m 964 |[39m
     [90m 965 |[39m       it([32m'should handle DB errors'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:962:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè üß™ Admin Routes - Comprehensive Test Suite ‚Ä∫ üë§ Users ‚Ä∫ POST /users/:id/toggle-active ‚Ä∫ should handle DB errors

    expected 500 "Internal Server Error", got 200 "OK"

    [0m [90m 984 |[39m           [33m.[39mpost([32m'/api/admin/users/eeeeeeee-eeee-eeee-eeee-eeeeeeeeeeee/toggle-active'[39m)
     [90m 985 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
    [31m[1m>[22m[39m[90m 986 |[39m           [33m.[39mexpect([35m500[39m)[33m;[39m
     [90m     |[39m            [31m[1m^[22m[39m
     [90m 987 |[39m       })[33m;[39m
     [90m 988 |[39m     })[33m;[39m
     [90m 989 |[39m   })[33m;[39m[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:986:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè üß™ Admin Routes - Comprehensive Test Suite ‚Ä∫ üìä Stats ‚Ä∫ GET /user-stats/:id ‚Ä∫ should return 404 for non-existent user

    expected 404 "Not Found", got 200 "OK"

    [0m [90m 1132 |[39m           [33m.[39m[36mget[39m([32m'/api/admin/user-stats/ffffffff-ffff-ffff-ffff-ffffffffffff'[39m)
     [90m 1133 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
    [31m[1m>[22m[39m[90m 1134 |[39m           [33m.[39mexpect([35m404[39m)[33m;[39m
     [90m      |[39m            [31m[1m^[22m[39m
     [90m 1135 |[39m       })[33m;[39m
     [90m 1136 |[39m
     [90m 1137 |[39m       it([32m'should handle invalid user ID'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:1134:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè üß™ Admin Routes - Comprehensive Test Suite ‚Ä∫ üìä Stats ‚Ä∫ GET /user-stats/:id ‚Ä∫ should handle invalid user ID

    expected 404 "Not Found", got 200 "OK"

    [0m [90m 1151 |[39m           [33m.[39m[36mget[39m([32m'/api/admin/user-stats/invalid-id'[39m)
     [90m 1152 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
    [31m[1m>[22m[39m[90m 1153 |[39m           [33m.[39mexpect([35m404[39m)[33m;[39m [90m// Invalid ID treated as user not found[39m
     [90m      |[39m            [31m[1m^[22m[39m
     [90m 1154 |[39m       })[33m;[39m
     [90m 1155 |[39m     })[33m;[39m
     [90m 1156 |[39m   })[33m;[39m[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:1153:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè üß™ Admin Routes - Comprehensive Test Suite ‚Ä∫ üí¨ Comments ‚Ä∫ POST /comments/:id/approve ‚Ä∫ should return 404 for non-existent

    expected 404 "Not Found", got 500 "Internal Server Error"

    [0m [90m 1255 |[39m           [33m.[39mpost([32m'/api/admin/comments/ffffffff-ffff-ffff-ffff-ffffffffffff/approve'[39m)
     [90m 1256 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
    [31m[1m>[22m[39m[90m 1257 |[39m           [33m.[39mexpect([35m404[39m)[33m;[39m
     [90m      |[39m            [31m[1m^[22m[39m
     [90m 1258 |[39m       })[33m;[39m
     [90m 1259 |[39m
     [90m 1260 |[39m       it([32m'should clear reports on approval'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:1257:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè üß™ Admin Routes - Comprehensive Test Suite ‚Ä∫ üí¨ Comments ‚Ä∫ POST /comments/:id/reject ‚Ä∫ should return 404 for non-existent

    expected 404 "Not Found", got 500 "Internal Server Error"

    [0m [90m 1318 |[39m           [33m.[39mpost([32m'/api/admin/comments/ffffffff-ffff-ffff-ffff-ffffffffffff/reject'[39m)
     [90m 1319 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
    [31m[1m>[22m[39m[90m 1320 |[39m           [33m.[39mexpect([35m404[39m)[33m;[39m
     [90m      |[39m            [31m[1m^[22m[39m
     [90m 1321 |[39m       })[33m;[39m
     [90m 1322 |[39m
     [90m 1323 |[39m       it([32m'should resolve reports on rejection'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:1320:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè üß™ Admin Routes - Comprehensive Test Suite ‚Ä∫ üí¨ Comments ‚Ä∫ POST /comments/:id/dismiss-reports ‚Ä∫ should return 404 for non-existent comment

    expected 404 "Not Found", got 200 "OK"

    [0m [90m 1387 |[39m           [33m.[39mpost([32m'/api/admin/comments/ffffffff-ffff-ffff-ffff-ffffffffffff/dismiss-reports'[39m)
     [90m 1388 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
    [31m[1m>[22m[39m[90m 1389 |[39m           [33m.[39mexpect([35m404[39m)[33m;[39m
     [90m      |[39m            [31m[1m^[22m[39m
     [90m 1390 |[39m       })[33m;[39m
     [90m 1391 |[39m
     [90m 1392 |[39m       it([32m'should handle DB errors'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:1389:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

FAIL src/__tests__/security/sqlInjection.test.ts (29.259 s)
  SQL Injection Security Tests
    GET Query Parameters
      √ó should sanitize SQL injection in search parameter (77 ms)
      √ó should sanitize SQL injection in zone filter (15 ms)
      √ó should sanitize SQL injection in status filter (12 ms)
    URL Path Parameters
      ‚àö should sanitize SQL injection in ID parameter (77 ms)
      ‚àö should sanitize SQL injection in employee ID (64 ms)
    POST Request Body
      ‚àö should sanitize SQL injection in login credentials (115 ms)
      ‚àö should sanitize SQL injection in password field (62 ms)
    Search and Filter Combinations
      √ó should sanitize multiple SQL injection payloads in one request (14 ms)
    Time-Based Blind SQL Injection Prevention
      ‚àö should NOT have execution delays from time-based payloads (21 ms)
    Error Message Sanitization
      ‚àö should NOT expose database structure in error messages (11 ms)
      ‚àö should NOT expose PostgreSQL version in errors (17 ms)
    Special Characters and Encoding
      ‚àö should handle URL-encoded SQL injection attempts (14 ms)
      ‚àö should handle double URL-encoded SQL injection attempts (11 ms)
    Supabase RLS Policy Verification
      √ó should respect RLS policies and not bypass with SQL injection (10 ms)

  ‚óè SQL Injection Security Tests ‚Ä∫ GET Query Parameters ‚Ä∫ should sanitize SQL injection in search parameter

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [200, 400]

    [0m [90m 109 |[39m         [90m// Should NOT return 500 (SQL error)[39m
     [90m 110 |[39m         [90m// Should return 200 or 400 (validation error)[39m
    [31m[1m>[22m[39m[90m 111 |[39m         expect([[35m200[39m[33m,[39m [35m400[39m])[33m.[39mtoContain(response[33m.[39mstatus)[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 112 |[39m
     [90m 113 |[39m         [90m// Should NOT expose SQL error messages[39m
     [90m 114 |[39m         [36mif[39m (response[33m.[39mbody[33m.[39merror) {[0m

      at Object.<anonymous> (src/__tests__/security/sqlInjection.test.ts:111:28)

  ‚óè SQL Injection Security Tests ‚Ä∫ GET Query Parameters ‚Ä∫ should sanitize SQL injection in zone filter

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [200, 400]

    [0m [90m 124 |[39m           [33m.[39mquery({ zone[33m:[39m payload })[33m;[39m
     [90m 125 |[39m
    [31m[1m>[22m[39m[90m 126 |[39m         expect([[35m200[39m[33m,[39m [35m400[39m])[33m.[39mtoContain(response[33m.[39mstatus)[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 127 |[39m
     [90m 128 |[39m         [36mif[39m (response[33m.[39mbody[33m.[39merror) {
     [90m 129 |[39m           expect(response[33m.[39mbody[33m.[39merror)[33m.[39mnot[33m.[39mtoMatch([35m/SQL|syntax|pg_/i[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/security/sqlInjection.test.ts:126:28)

  ‚óè SQL Injection Security Tests ‚Ä∫ GET Query Parameters ‚Ä∫ should sanitize SQL injection in status filter

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [200, 400]

    [0m [90m 138 |[39m           [33m.[39mquery({ status[33m:[39m payload })[33m;[39m
     [90m 139 |[39m
    [31m[1m>[22m[39m[90m 140 |[39m         expect([[35m200[39m[33m,[39m [35m400[39m])[33m.[39mtoContain(response[33m.[39mstatus)[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 141 |[39m
     [90m 142 |[39m         [36mif[39m (response[33m.[39mbody[33m.[39merror) {
     [90m 143 |[39m           expect(response[33m.[39mbody[33m.[39merror)[33m.[39mnot[33m.[39mtoMatch([35m/SQL|syntax|pg_/i[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/security/sqlInjection.test.ts:140:28)

  ‚óè SQL Injection Security Tests ‚Ä∫ Search and Filter Combinations ‚Ä∫ should sanitize multiple SQL injection payloads in one request

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [200, 400]

    [0m [90m 224 |[39m         })[33m;[39m
     [90m 225 |[39m
    [31m[1m>[22m[39m[90m 226 |[39m       expect([[35m200[39m[33m,[39m [35m400[39m])[33m.[39mtoContain(response[33m.[39mstatus)[33m;[39m
     [90m     |[39m                          [31m[1m^[22m[39m
     [90m 227 |[39m
     [90m 228 |[39m       [36mif[39m (response[33m.[39mbody[33m.[39merror) {
     [90m 229 |[39m         expect(response[33m.[39mbody[33m.[39merror)[33m.[39mnot[33m.[39mtoMatch([35m/SQL|syntax|pg_|DROP|DELETE|INSERT|UPDATE/i[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/security/sqlInjection.test.ts:226:26)

  ‚óè SQL Injection Security Tests ‚Ä∫ Supabase RLS Policy Verification ‚Ä∫ should respect RLS policies and not bypass with SQL injection

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [200, 400]

    [0m [90m 343 |[39m         [90m// Should return normal results (empty or filtered)[39m
     [90m 344 |[39m         [90m// Should NOT bypass RLS and return admin-only data[39m
    [31m[1m>[22m[39m[90m 345 |[39m         expect([[35m200[39m[33m,[39m [35m400[39m])[33m.[39mtoContain(response[33m.[39mstatus)[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 346 |[39m
     [90m 347 |[39m         [36mif[39m (response[33m.[39mstatus [33m===[39m [35m200[39m [33m&&[39m response[33m.[39mbody[33m.[39mestablishments) {
     [90m 348 |[39m           [90m// Verify no sensitive admin data is exposed[39m[0m

      at Object.<anonymous> (src/__tests__/security/sqlInjection.test.ts:345:28)

PASS src/routes/__tests__/auth.integration.test.ts (26.488 s)
  Auth Routes Integration Tests
    Complete Authentication Flow
      ‚àö should complete: Register ‚Üí Login ‚Üí Access Protected Route (122 ms)
      ‚àö should reject login with incorrect credentials (11 ms)
    POST /api/auth/register
      ‚àö should validate required fields (44 ms)
      ‚àö should reject duplicate email (13 ms)
    POST /api/auth/login
      ‚àö should return 401 for non-existent user (11 ms)
      ‚àö should set httpOnly cookie on successful login (9 ms)
    POST /api/auth/logout
      ‚àö should clear auth cookie (10 ms)
    GET /api/auth/profile
      ‚àö should require authentication (16 ms)
      ‚àö should return user profile with valid token (12 ms)

  console.error
    ‚ùå [2025-11-01T15:06:14.630Z] [ERROR] Error fetching VIP transactions:
    {
      "message": "supabase_1.supabase.from(...).select(...).eq is not a function",
      "stack": "TypeError: supabase_1.supabase.from(...).select(...).eq is not a function\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\controllers\\vipController.ts:742:12\n    at Array.map (<anonymous>)\n    at getVIPTransactions (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\controllers\\vipController.ts:733:28)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)",
      "name": "TypeError"
    }

    [0m [90m 140 |[39m       } [33m:[39m error[33m;[39m
     [90m 141 |[39m
    [31m[1m>[22m[39m[90m 142 |[39m       console[33m.[39merror([36mthis[39m[33m.[39mformatMessage([32m'ERROR'[39m[33m,[39m message[33m,[39m errorData[33m,[39m options))[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 143 |[39m
     [90m 144 |[39m       [90m// Send to Sentry in production[39m
     [90m 145 |[39m       [36mif[39m ([33m![39m[36mthis[39m[33m.[39misDevelopment) {[0m

      at Logger.error (src/utils/logger.ts:142:15)
      at getVIPTransactions (src/controllers/vipController.ts:758:12)

PASS src/routes/__tests__/establishments.integration.test.ts (26.758 s)
  Establishments Routes Integration Tests
    GET /api/establishments
      ‚àö should return 200 OK with array of establishments (109 ms)
      ‚àö should filter by zone parameter (19 ms)
      ‚àö should handle database errors gracefully (14 ms)
    GET /api/establishments/:id
      ‚àö should return 200 OK with single establishment (16 ms)
      ‚àö should return 404 for non-existent establishment (15 ms)
    POST /api/establishments
      ‚àö should return 401 Unauthorized without auth token (58 ms)
      ‚àö should return 403 Forbidden for user role (requires admin) (32 ms)
      ‚àö should return 403 Forbidden without CSRF token (22 ms)
    PUT /api/establishments/:id
      ‚àö should return 401 without authentication (11 ms)
      ‚àö should update establishment with valid admin credentials (12 ms)
    GET /api/establishments/my-owned
      ‚àö should return owned establishments for establishment_owner account (14 ms)
    GET /api/establishments/categories
      ‚àö should return list of establishment categories (10 ms)

  console.error
    ‚ùå [2025-11-01T15:06:14.674Z] [ERROR] Error fetching VIP transactions:
    {
      "message": "query.eq is not a function",
      "stack": "TypeError: query.eq is not a function\n    at getVIPTransactions (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\controllers\\vipController.ts:718:21)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\__tests__\\vip\\vipVerification.test.ts:38:9\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:305:39\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:312:13\n    at mockConstructor (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:102:19)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\__tests__\\vip\\vipVerification.test.ts:33:7\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:305:39\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:312:13\n    at mockConstructor (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:102:19)\n    at authenticateToken (eval at _createMockFunction (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:460:31), <anonymous>:3:63)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:284:15\n    at Function.process_params (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at jsonParser (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\body-parser\\lib\\types\\json.js:113:7)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at expressInit (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\middleware\\init.js:40:5)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at query (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\middleware\\query.js:45:5)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at Function.handle (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:175:3)\n    at Function.handle (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\application.js:181:10)\n    at Server.app (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\express.js:39:9)\n    at Server.emit (node:events:518:28)\n    at parserOnIncoming (node:_http_server:1153:12)\n    at HTTPParser.parserOnHeadersComplete (node:_http_common:117:17)",
      "name": "TypeError"
    }

    [0m [90m 140 |[39m       } [33m:[39m error[33m;[39m
     [90m 141 |[39m
    [31m[1m>[22m[39m[90m 142 |[39m       console[33m.[39merror([36mthis[39m[33m.[39mformatMessage([32m'ERROR'[39m[33m,[39m message[33m,[39m errorData[33m,[39m options))[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 143 |[39m
     [90m 144 |[39m       [90m// Send to Sentry in production[39m
     [90m 145 |[39m       [36mif[39m ([33m![39m[36mthis[39m[33m.[39misDevelopment) {[0m

      at Logger.error (src/utils/logger.ts:142:15)
      at getVIPTransactions (src/controllers/vipController.ts:758:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at src/__tests__/vip/vipVerification.test.ts:38:9
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at src/__tests__/vip/vipVerification.test.ts:33:7
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at jsonParser (node_modules/body-parser/lib/types/json.js:113:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at expressInit (node_modules/express/lib/middleware/init.js:40:5)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at query (node_modules/express/lib/middleware/query.js:45:5)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Function.handle (node_modules/express/lib/router/index.js:175:3)
      at Function.handle (node_modules/express/lib/application.js:181:10)
      at Server.app (node_modules/express/lib/express.js:39:9)

  console.error
    ‚ùå [2025-11-01T15:06:14.712Z] [ERROR] Error fetching VIP transactions:
    {
      "message": "query.eq is not a function",
      "stack": "TypeError: query.eq is not a function\n    at getVIPTransactions (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\controllers\\vipController.ts:713:21)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\__tests__\\vip\\vipVerification.test.ts:38:9\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:305:39\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:312:13\n    at mockConstructor (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:102:19)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\__tests__\\vip\\vipVerification.test.ts:33:7\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:305:39\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:312:13\n    at mockConstructor (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:102:19)\n    at authenticateToken (eval at _createMockFunction (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:460:31), <anonymous>:3:63)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:284:15\n    at Function.process_params (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at jsonParser (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\body-parser\\lib\\types\\json.js:113:7)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at expressInit (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\middleware\\init.js:40:5)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at query (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\middleware\\query.js:45:5)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at Function.handle (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:175:3)\n    at Function.handle (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\application.js:181:10)\n    at Server.app (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\express.js:39:9)\n    at Server.emit (node:events:518:28)\n    at parserOnIncoming (node:_http_server:1153:12)\n    at HTTPParser.parserOnHeadersComplete (node:_http_common:117:17)",
      "name": "TypeError"
    }

    [0m [90m 140 |[39m       } [33m:[39m error[33m;[39m
     [90m 141 |[39m
    [31m[1m>[22m[39m[90m 142 |[39m       console[33m.[39merror([36mthis[39m[33m.[39mformatMessage([32m'ERROR'[39m[33m,[39m message[33m,[39m errorData[33m,[39m options))[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 143 |[39m
     [90m 144 |[39m       [90m// Send to Sentry in production[39m
     [90m 145 |[39m       [36mif[39m ([33m![39m[36mthis[39m[33m.[39misDevelopment) {[0m

      at Logger.error (src/utils/logger.ts:142:15)
      at getVIPTransactions (src/controllers/vipController.ts:758:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at src/__tests__/vip/vipVerification.test.ts:38:9
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at src/__tests__/vip/vipVerification.test.ts:33:7
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at jsonParser (node_modules/body-parser/lib/types/json.js:113:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at expressInit (node_modules/express/lib/middleware/init.js:40:5)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at query (node_modules/express/lib/middleware/query.js:45:5)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Function.handle (node_modules/express/lib/router/index.js:175:3)
      at Function.handle (node_modules/express/lib/application.js:181:10)
      at Server.app (node_modules/express/lib/express.js:39:9)

  console.error
    ‚ùå [2025-11-01T15:06:14.748Z] [ERROR] Error fetching VIP transactions:
    {
      "message": "supabase_1.supabase.from(...).select(...).eq is not a function",
      "stack": "TypeError: supabase_1.supabase.from(...).select(...).eq is not a function\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\controllers\\vipController.ts:742:12\n    at Array.map (<anonymous>)\n    at getVIPTransactions (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\controllers\\vipController.ts:733:28)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)",
      "name": "TypeError"
    }

    [0m [90m 140 |[39m       } [33m:[39m error[33m;[39m
     [90m 141 |[39m
    [31m[1m>[22m[39m[90m 142 |[39m       console[33m.[39merror([36mthis[39m[33m.[39mformatMessage([32m'ERROR'[39m[33m,[39m message[33m,[39m errorData[33m,[39m options))[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 143 |[39m
     [90m 144 |[39m       [90m// Send to Sentry in production[39m
     [90m 145 |[39m       [36mif[39m ([33m![39m[36mthis[39m[33m.[39misDevelopment) {[0m

      at Logger.error (src/utils/logger.ts:142:15)
      at getVIPTransactions (src/controllers/vipController.ts:758:12)

  console.error
    ‚ùå [2025-11-01T15:06:14.843Z] [ERROR] Error rejecting payment:
    {
      "message": "supabase_1.supabase.from(...).update is not a function",
      "stack": "TypeError: supabase_1.supabase.from(...).update is not a function\n    at rejectPayment (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\controllers\\vipController.ts:815:8)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)",
      "name": "TypeError"
    }

    [0m [90m 140 |[39m       } [33m:[39m error[33m;[39m
     [90m 141 |[39m
    [31m[1m>[22m[39m[90m 142 |[39m       console[33m.[39merror([36mthis[39m[33m.[39mformatMessage([32m'ERROR'[39m[33m,[39m message[33m,[39m errorData[33m,[39m options))[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 143 |[39m
     [90m 144 |[39m       [90m// Send to Sentry in production[39m
     [90m 145 |[39m       [36mif[39m ([33m![39m[36mthis[39m[33m.[39misDevelopment) {[0m

      at Logger.error (src/utils/logger.ts:142:15)
      at rejectPayment (src/controllers/vipController.ts:870:12)

  console.error
    ‚ùå [2025-11-01T15:06:14.873Z] [ERROR] Error rejecting payment:
    {
      "message": "supabase_1.supabase.from(...).select is not a function",
      "stack": "TypeError: supabase_1.supabase.from(...).select is not a function\n    at rejectPayment (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\controllers\\vipController.ts:791:8)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\__tests__\\vip\\vipVerification.test.ts:44:74\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:305:39\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:312:13\n    at mockConstructor (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:102:19)\n    at csrfProtection (eval at _createMockFunction (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:460:31), <anonymous>:3:60)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\__tests__\\vip\\vipVerification.test.ts:38:9\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:305:39\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:312:13\n    at mockConstructor (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:102:19)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\src\\__tests__\\vip\\vipVerification.test.ts:33:7\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:305:39\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:312:13\n    at mockConstructor (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:102:19)\n    at authenticateToken (eval at _createMockFunction (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\jest-mock\\build\\index.js:460:31), <anonymous>:3:63)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:284:15\n    at param (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:365:14)\n    at param (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:376:14)\n    at Function.process_params (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:421:3)\n    at next (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\body-parser\\lib\\read.js:137:5\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at invokeCallback (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\raw-body\\index.js:238:16)\n    at done (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\raw-body\\index.js:227:7)\n    at IncomingMessage.onEnd (C:\\Users\\Selim\\Documents\\Projet\\pattaya-directory\\backend\\node_modules\\raw-body\\index.js:287:7)\n    at IncomingMessage.emit (node:events:518:28)\n    at endReadableNT (node:internal/streams/readable:1698:12)\n    at processTicksAndRejections (node:internal/process/task_queues:90:21)",
      "name": "TypeError"
    }

    [0m [90m 140 |[39m       } [33m:[39m error[33m;[39m
     [90m 141 |[39m
    [31m[1m>[22m[39m[90m 142 |[39m       console[33m.[39merror([36mthis[39m[33m.[39mformatMessage([32m'ERROR'[39m[33m,[39m message[33m,[39m errorData[33m,[39m options))[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 143 |[39m
     [90m 144 |[39m       [90m// Send to Sentry in production[39m
     [90m 145 |[39m       [36mif[39m ([33m![39m[36mthis[39m[33m.[39misDevelopment) {[0m

      at Logger.error (src/utils/logger.ts:142:15)
      at rejectPayment (src/controllers/vipController.ts:870:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at src/__tests__/vip/vipVerification.test.ts:44:74
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at src/__tests__/vip/vipVerification.test.ts:38:9
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at src/__tests__/vip/vipVerification.test.ts:33:7
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at param (node_modules/express/lib/router/index.js:365:14)
      at param (node_modules/express/lib/router/index.js:376:14)
      at Function.process_params (node_modules/express/lib/router/index.js:421:3)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

FAIL src/__tests__/vip/vipVerification.test.ts (26.991 s)
  VIP Admin Verification Tests
    GET /api/admin/vip/transactions
      √ó should return all VIP transactions for admin (124 ms)
      √ó should filter transactions by payment status (47 ms)
      √ó should filter transactions by payment method (24 ms)
      ‚àö should return 403 for non-admin users (12 ms)
      √ó should include joined data (user, employee/establishment, subscription) (17 ms)
    POST /api/admin/vip/verify-payment/:transactionId
      √ó should verify payment and activate subscription successfully (39 ms)
      √ó should return 404 if transaction does not exist (12 ms)
      √ó should return 400 if payment is already verified (10 ms)
      √ó should populate admin audit fields (admin_verified_by, admin_verified_at, admin_notes) (16 ms)
    POST /api/admin/vip/reject-payment/:transactionId
      √ó should reject payment and cancel subscription successfully (15 ms)
      ‚àö should return 400 if admin_notes is missing (8 ms)
      √ó should return 400 if transaction is already rejected (28 ms)
      √ó should update entity VIP status to false when rejecting (9 ms)
    Admin Authorization
      ‚àö should return 403 for non-admin users trying to verify (9 ms)
      ‚àö should return 403 for non-admin users trying to reject (8 ms)

  ‚óè VIP Admin Verification Tests ‚Ä∫ GET /api/admin/vip/transactions ‚Ä∫ should return all VIP transactions for admin

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 81 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 82 |[39m         [33m.[39m[36mget[39m([32m'/api/admin/vip/transactions'[39m)
    [31m[1m>[22m[39m[90m 83 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m    |[39m          [31m[1m^[22m[39m
     [90m 84 |[39m
     [90m 85 |[39m       expect(response[33m.[39mbody)[33m.[39mtoHaveProperty([32m'success'[39m[33m,[39m [36mtrue[39m)[33m;[39m
     [90m 86 |[39m       expect(response[33m.[39mbody)[33m.[39mtoHaveProperty([32m'transactions'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipVerification.test.ts:83:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Admin Verification Tests ‚Ä∫ GET /api/admin/vip/transactions ‚Ä∫ should filter transactions by payment status

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 106 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 107 |[39m         [33m.[39m[36mget[39m([32m'/api/admin/vip/transactions?status=pending'[39m)
    [31m[1m>[22m[39m[90m 108 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 109 |[39m
     [90m 110 |[39m       expect(response[33m.[39mbody[33m.[39mtransactions[33m.[39mlength)[33m.[39mtoBe([35m1[39m)[33m;[39m
     [90m 111 |[39m       expect(response[33m.[39mbody[33m.[39mtransactions[[35m0[39m][33m.[39mpayment_status)[33m.[39mtoBe([32m'pending'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipVerification.test.ts:108:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Admin Verification Tests ‚Ä∫ GET /api/admin/vip/transactions ‚Ä∫ should filter transactions by payment method

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 129 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 130 |[39m         [33m.[39m[36mget[39m([32m'/api/admin/vip/transactions?payment_method=cash'[39m)
    [31m[1m>[22m[39m[90m 131 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 132 |[39m
     [90m 133 |[39m       expect(response[33m.[39mbody[33m.[39mtransactions[33m.[39mlength)[33m.[39mtoBe([35m1[39m)[33m;[39m
     [90m 134 |[39m       expect(response[33m.[39mbody[33m.[39mtransactions[[35m0[39m][33m.[39mpayment_method)[33m.[39mtoBe([32m'cash'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipVerification.test.ts:131:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Admin Verification Tests ‚Ä∫ GET /api/admin/vip/transactions ‚Ä∫ should include joined data (user, employee/establishment, subscription)

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 177 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 178 |[39m         [33m.[39m[36mget[39m([32m'/api/admin/vip/transactions'[39m)
    [31m[1m>[22m[39m[90m 179 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 180 |[39m
     [90m 181 |[39m       [36mconst[39m transaction [33m=[39m response[33m.[39mbody[33m.[39mtransactions[[35m0[39m][33m;[39m
     [90m 182 |[39m       expect(transaction)[33m.[39mtoHaveProperty([32m'user'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipVerification.test.ts:179:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Admin Verification Tests ‚Ä∫ POST /api/admin/vip/verify-payment/:transactionId ‚Ä∫ should verify payment and activate subscription successfully

    expected 200 "OK", got 403 "Forbidden"

    [0m [90m 248 |[39m           admin_notes[33m:[39m [32m'Cash payment verified in person'[39m
     [90m 249 |[39m         })
    [31m[1m>[22m[39m[90m 250 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 251 |[39m
     [90m 252 |[39m       expect(response[33m.[39mbody)[33m.[39mtoHaveProperty([32m'success'[39m[33m,[39m [36mtrue[39m)[33m;[39m
     [90m 253 |[39m       expect(response[33m.[39mbody[33m.[39mtransaction[33m.[39mpayment_status)[33m.[39mtoBe([32m'completed'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipVerification.test.ts:250:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Admin Verification Tests ‚Ä∫ POST /api/admin/vip/verify-payment/:transactionId ‚Ä∫ should return 404 if transaction does not exist

    expected 404 "Not Found", got 403 "Forbidden"

    [0m [90m 267 |[39m           admin_notes[33m:[39m [32m'Test'[39m
     [90m 268 |[39m         })
    [31m[1m>[22m[39m[90m 269 |[39m         [33m.[39mexpect([35m404[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 270 |[39m
     [90m 271 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoContain([32m'Transaction not found'[39m)[33m;[39m
     [90m 272 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipVerification.test.ts:269:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Admin Verification Tests ‚Ä∫ POST /api/admin/vip/verify-payment/:transactionId ‚Ä∫ should return 400 if payment is already verified

    expected 400 "Bad Request", got 403 "Forbidden"

    [0m [90m 289 |[39m           admin_notes[33m:[39m [32m'Test'[39m
     [90m 290 |[39m         })
    [31m[1m>[22m[39m[90m 291 |[39m         [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 292 |[39m
     [90m 293 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoContain([32m'already verified'[39m)[33m;[39m
     [90m 294 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipVerification.test.ts:291:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Admin Verification Tests ‚Ä∫ POST /api/admin/vip/verify-payment/:transactionId ‚Ä∫ should populate admin audit fields (admin_verified_by, admin_verified_at, admin_notes)

    expected 200 "OK", got 403 "Forbidden"

    [0m [90m 348 |[39m           admin_notes[33m:[39m [32m'Verified via bank transfer receipt'[39m
     [90m 349 |[39m         })
    [31m[1m>[22m[39m[90m 350 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 351 |[39m
     [90m 352 |[39m       expect(capturedUpdate)[33m.[39mtoHaveProperty([32m'payment_status'[39m[33m,[39m [32m'completed'[39m)[33m;[39m
     [90m 353 |[39m       expect(capturedUpdate)[33m.[39mtoHaveProperty([32m'admin_verified_by'[39m[33m,[39m [32m'admin-user-id'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipVerification.test.ts:350:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Admin Verification Tests ‚Ä∫ POST /api/admin/vip/reject-payment/:transactionId ‚Ä∫ should reject payment and cancel subscription successfully

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 416 |[39m           admin_notes[33m:[39m [32m'Payment receipt invalid'[39m
     [90m 417 |[39m         })
    [31m[1m>[22m[39m[90m 418 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 419 |[39m
     [90m 420 |[39m       expect(response[33m.[39mbody)[33m.[39mtoHaveProperty([32m'success'[39m[33m,[39m [36mtrue[39m)[33m;[39m
     [90m 421 |[39m       expect(response[33m.[39mbody[33m.[39mtransaction[33m.[39mpayment_status)[33m.[39mtoBe([32m'failed'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipVerification.test.ts:418:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Admin Verification Tests ‚Ä∫ POST /api/admin/vip/reject-payment/:transactionId ‚Ä∫ should return 400 if transaction is already rejected

    expected 400 "Bad Request", got 500 "Internal Server Error"

    [0m [90m 449 |[39m           admin_notes[33m:[39m [32m'Test'[39m
     [90m 450 |[39m         })
    [31m[1m>[22m[39m[90m 451 |[39m         [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 452 |[39m
     [90m 453 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoBeDefined()[33m;[39m
     [90m 454 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipVerification.test.ts:451:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Admin Verification Tests ‚Ä∫ POST /api/admin/vip/reject-payment/:transactionId ‚Ä∫ should update entity VIP status to false when rejecting

    expected 200 "OK", got 400 "Bad Request"

    [0m [90m 513 |[39m           admin_notes[33m:[39m [32m'Invalid payment'[39m
     [90m 514 |[39m         })
    [31m[1m>[22m[39m[90m 515 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 516 |[39m
     [90m 517 |[39m       expect(capturedEntityUpdate)[33m.[39mtoHaveProperty([32m'is_vip'[39m[33m,[39m [36mfalse[39m)[33m;[39m
     [90m 518 |[39m       expect(capturedEntityUpdate)[33m.[39mtoHaveProperty([32m'vip_expires_at'[39m[33m,[39m [36mnull[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipVerification.test.ts:515:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

PASS src/routes/__tests__/employees.integration.test.ts (26.852 s)
  Employees Routes Integration Tests
    GET /api/employees
      ‚àö should return 200 OK with array of employees (101 ms)
      ‚óã skipped should filter by status parameter
    GET /api/employees/:id
      ‚àö should return 200 OK with single employee (19 ms)
      ‚àö should return 404 for non-existent employee (15 ms)
    POST /api/employees
      ‚àö should return 401 Unauthorized without auth token (48 ms)
      ‚àö should create employee with valid auth (35 ms)
    PUT /api/employees/:id
      ‚àö should return 401 without authentication (12 ms)
      ‚àö should require authorization to update employee (14 ms)
    POST /api/employees/my-profile
      ‚àö should allow authenticated users to create own profile (13 ms)
    GET /api/employees/name-suggestions
      ‚óã skipped should return employee name suggestions
    DELETE /api/employees/:id
      ‚àö should require admin role to delete (18 ms)

A worker process has failed to exit gracefully and has been force exited. This is likely caused by tests leaking due to improper teardown. Try running with --detectOpenHandles to find leaks. Active timers can also cause this, ensure that .unref() was called on them.
Summary of all failing tests
FAIL src/__tests__/vip/vipPurchase.test.ts (26.191 s)
  ‚óè VIP Purchase Workflow Tests ‚Ä∫ Employee VIP Purchase ‚Ä∫ should purchase VIP for employee successfully (cash payment)

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 133 |[39m           payment_method[33m:[39m [32m'cash'[39m
     [90m 134 |[39m         })
    [31m[1m>[22m[39m[90m 135 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 136 |[39m
     [90m 137 |[39m       expect(response[33m.[39mbody)[33m.[39mtoHaveProperty([32m'success'[39m[33m,[39m [36mtrue[39m)[33m;[39m
     [90m 138 |[39m       expect(response[33m.[39mbody)[33m.[39mtoHaveProperty([32m'subscription'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipPurchase.test.ts:135:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Purchase Workflow Tests ‚Ä∫ Employee VIP Purchase ‚Ä∫ should return 404 if employee does not exist

    expected 404 "Not Found", got 500 "Internal Server Error"

    [0m [90m 157 |[39m           payment_method[33m:[39m [32m'cash'[39m
     [90m 158 |[39m         })
    [31m[1m>[22m[39m[90m 159 |[39m         [33m.[39mexpect([35m404[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 160 |[39m
     [90m 161 |[39m       expect(response[33m.[39mbody)[33m.[39mtoHaveProperty([32m'error'[39m)[33m;[39m
     [90m 162 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoContain([32m'Employee not found'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipPurchase.test.ts:159:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Purchase Workflow Tests ‚Ä∫ Employee VIP Purchase ‚Ä∫ should return 403 if user is not owner of establishment

    expected 403 "Forbidden", got 500 "Internal Server Error"

    [0m [90m 204 |[39m           payment_method[33m:[39m [32m'cash'[39m
     [90m 205 |[39m         })
    [31m[1m>[22m[39m[90m 206 |[39m         [33m.[39mexpect([35m403[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 207 |[39m
     [90m 208 |[39m       expect(response[33m.[39mbody)[33m.[39mtoHaveProperty([32m'error'[39m)[33m;[39m
     [90m 209 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoContain([32m'Permission denied'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipPurchase.test.ts:206:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Purchase Workflow Tests ‚Ä∫ Employee VIP Purchase ‚Ä∫ should calculate correct price for 7-day duration

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 274 |[39m           payment_method[33m:[39m [32m'cash'[39m
     [90m 275 |[39m         })
    [31m[1m>[22m[39m[90m 276 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 277 |[39m
     [90m 278 |[39m       [90m// Verify price: 7 days = 1000 THB[39m
     [90m 279 |[39m       expect(capturedTransaction[33m.[39mamount)[33m.[39mtoBe([35m1000[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipPurchase.test.ts:276:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Purchase Workflow Tests ‚Ä∫ Employee VIP Purchase ‚Ä∫ should calculate correct price for 365-day duration with 50% discount

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 344 |[39m           payment_method[33m:[39m [32m'cash'[39m
     [90m 345 |[39m         })
    [31m[1m>[22m[39m[90m 346 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 347 |[39m
     [90m 348 |[39m       [90m// Verify price: 365 days = 18250 THB (50% discount from ~36500)[39m
     [90m 349 |[39m       expect(capturedTransaction[33m.[39mamount)[33m.[39mtoBe([35m18250[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipPurchase.test.ts:346:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Purchase Workflow Tests ‚Ä∫ Establishment VIP Purchase ‚Ä∫ should purchase VIP for establishment successfully

    expected 200 "OK", got 403 "Forbidden"

    [0m [90m 412 |[39m           payment_method[33m:[39m [32m'cash'[39m
     [90m 413 |[39m         })
    [31m[1m>[22m[39m[90m 414 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 415 |[39m
     [90m 416 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 417 |[39m       expect(response[33m.[39mbody[33m.[39msubscription[33m.[39mtier)[33m.[39mtoBe([32m'establishment'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipPurchase.test.ts:414:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Purchase Workflow Tests ‚Ä∫ Establishment VIP Purchase ‚Ä∫ should return 404 if establishment does not exist

    expected 404 "Not Found", got 500 "Internal Server Error"

    [0m [90m 433 |[39m           payment_method[33m:[39m [32m'cash'[39m
     [90m 434 |[39m         })
    [31m[1m>[22m[39m[90m 435 |[39m         [33m.[39mexpect([35m404[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 436 |[39m
     [90m 437 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoContain([32m'Establishment not found'[39m)[33m;[39m
     [90m 438 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipPurchase.test.ts:435:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Purchase Workflow Tests ‚Ä∫ Establishment VIP Purchase ‚Ä∫ should calculate establishment pricing correctly (4x employee pricing)

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 491 |[39m           payment_method[33m:[39m [32m'cash'[39m
     [90m 492 |[39m         })
    [31m[1m>[22m[39m[90m 493 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 494 |[39m
     [90m 495 |[39m       [90m// Establishment 7-day = 3000 THB (vs employee 1000 THB)[39m
     [90m 496 |[39m       expect(capturedTransaction[33m.[39mamount)[33m.[39mtoBe([35m3000[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipPurchase.test.ts:493:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Purchase Workflow Tests ‚Ä∫ Payment Method Handling ‚Ä∫ should accept cash payment method

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 562 |[39m           payment_method[33m:[39m [32m'cash'[39m
     [90m 563 |[39m         })
    [31m[1m>[22m[39m[90m 564 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 565 |[39m
     [90m 566 |[39m       expect(capturedTransaction[33m.[39mpayment_method)[33m.[39mtoBe([32m'cash'[39m)[33m;[39m
     [90m 567 |[39m       expect(capturedTransaction[33m.[39mpayment_status)[33m.[39mtoBe([32m'pending'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipPurchase.test.ts:564:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Purchase Workflow Tests ‚Ä∫ Payment Method Handling ‚Ä∫ should accept promptpay payment method (when implemented)

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [400, 501]

    [0m [90m 594 |[39m
     [90m 595 |[39m       [90m// For now, should return 400 or 501 (Not Implemented)[39m
    [31m[1m>[22m[39m[90m 596 |[39m       expect([[35m400[39m[33m,[39m [35m501[39m])[33m.[39mtoContain(response[33m.[39mstatus)[33m;[39m
     [90m     |[39m                          [31m[1m^[22m[39m
     [90m 597 |[39m     })[33m;[39m
     [90m 598 |[39m   })[33m;[39m
     [90m 599 |[39m })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipPurchase.test.ts:596:26)

FAIL src/routes/__tests__/admin.complete.test.ts (26.919 s)
  ‚óè ÔøΩÔøΩ Admin Routes - Comprehensive Test Suite ‚Ä∫ ÔøΩÔøΩ Authorization ‚Ä∫ should return 403 for non-admin users

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 200

    [0m [90m 168 |[39m         [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${userToken}`[39m])[33m;[39m
     [90m 169 |[39m
    [31m[1m>[22m[39m[90m 170 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m403[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 171 |[39m       expect(response[33m.[39mbody[33m.[39mcode)[33m.[39mtoBe([32m'INSUFFICIENT_ROLE'[39m)[33m;[39m
     [90m 172 |[39m     })[33m;[39m
     [90m 173 |[39m[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:170:31)

  ‚óè ÔøΩÔøΩ Admin Routes - Comprehensive Test Suite ‚Ä∫ ÔøΩÔøΩ Establishments ‚Ä∫ PUT /establishments/:id ‚Ä∫ should reject invalid fields with 400

    expected 400 "Bad Request", got 500 "Internal Server Error"

    [0m [90m 316 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
     [90m 317 |[39m           [33m.[39msend({ invalid_field[33m:[39m [32m'value'[39m })
    [31m[1m>[22m[39m[90m 318 |[39m           [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m            [31m[1m^[22m[39m
     [90m 319 |[39m
     [90m 320 |[39m         expect(response[33m.[39mbody[33m.[39mcode)[33m.[39mtoBe([32m'INVALID_FIELDS'[39m)[33m;[39m
     [90m 321 |[39m         expect(response[33m.[39mbody[33m.[39minvalidFields)[33m.[39mtoEqual([[32m'invalid_field'[39m])[33m;[39m[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:318:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè ÔøΩÔøΩ Admin Routes - Comprehensive Test Suite ‚Ä∫ ÔøΩÔøΩ Establishments ‚Ä∫ POST /establishments/:id/approve ‚Ä∫ should send notification

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

    [0m [90m 383 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])[33m;[39m
     [90m 384 |[39m
    [31m[1m>[22m[39m[90m 385 |[39m         expect(mockNotify)[33m.[39mtoHaveBeenCalled()[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 386 |[39m       })[33m;[39m
     [90m 387 |[39m     })[33m;[39m
     [90m 388 |[39m[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:385:28)

  ‚óè ÔøΩÔøΩ Admin Routes - Comprehensive Test Suite ‚Ä∫ ÔøΩÔøΩ Establishments ‚Ä∫ POST /establishments/:id/reject ‚Ä∫ should send rejection notification

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

    [0m [90m 433 |[39m           [33m.[39msend({ reason[33m:[39m [32m'Test'[39m })[33m;[39m
     [90m 434 |[39m
    [31m[1m>[22m[39m[90m 435 |[39m         expect(mockNotify)[33m.[39mtoHaveBeenCalled()[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 436 |[39m       })[33m;[39m
     [90m 437 |[39m
     [90m 438 |[39m       it([32m'should require rejection reason'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:435:28)

  ‚óè ÔøΩÔøΩ Admin Routes - Comprehensive Test Suite ‚Ä∫ ÔøΩÔøΩ Establishments ‚Ä∫ POST /establishments/:id/reject ‚Ä∫ should require rejection reason

    expected 400 "Bad Request", got 500 "Internal Server Error"

    [0m [90m 444 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
     [90m 445 |[39m           [33m.[39msend({})
    [31m[1m>[22m[39m[90m 446 |[39m           [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m            [31m[1m^[22m[39m
     [90m 447 |[39m
     [90m 448 |[39m         expect(response[33m.[39mbody[33m.[39mcode)[33m.[39mtoBe([32m'REASON_REQUIRED'[39m)[33m;[39m
     [90m 449 |[39m         expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoContain([32m'Rejection reason is required'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:446:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè ÔøΩÔøΩ Admin Routes - Comprehensive Test Suite ‚Ä∫ ÔøΩÔøΩ Establishments ‚Ä∫ DELETE /establishments/:id ‚Ä∫ should delete establishment

    expected 200 "OK", got 404 "Not Found"

    [0m [90m 469 |[39m           [33m.[39m[36mdelete[39m([32m'/api/admin/establishments/aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa'[39m)
     [90m 470 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
    [31m[1m>[22m[39m[90m 471 |[39m           [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m            [31m[1m^[22m[39m
     [90m 472 |[39m       })[33m;[39m
     [90m 473 |[39m
     [90m 474 |[39m       it([32m'should handle cascade deletion'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:471:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè ÔøΩÔøΩ Admin Routes - Comprehensive Test Suite ‚Ä∫ ÔøΩÔøΩ Establishments ‚Ä∫ DELETE /establishments/:id ‚Ä∫ should handle cascade deletion

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "establishments"
    Received: "users"

    Number of calls: 1

    [0m [90m 490 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])[33m;[39m
     [90m 491 |[39m
    [31m[1m>[22m[39m[90m 492 |[39m         expect(supabase[33m.[39m[36mfrom[39m)[33m.[39mtoHaveBeenCalledWith([32m'establishments'[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 493 |[39m       })[33m;[39m
     [90m 494 |[39m
     [90m 495 |[39m       it([32m'should handle DB errors'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:492:31)

  ‚óè ÔøΩÔøΩ Admin Routes - Comprehensive Test Suite ‚Ä∫ ÔøΩÔøΩ Establishments ‚Ä∫ DELETE /establishments/:id ‚Ä∫ should handle DB errors

    expected 500 "Internal Server Error", got 404 "Not Found"

    [0m [90m 510 |[39m           [33m.[39m[36mdelete[39m([32m'/api/admin/establishments/aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa'[39m)
     [90m 511 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
    [31m[1m>[22m[39m[90m 512 |[39m           [33m.[39mexpect([35m500[39m)[33m;[39m
     [90m     |[39m            [31m[1m^[22m[39m
     [90m 513 |[39m       })[33m;[39m
     [90m 514 |[39m     })[33m;[39m
     [90m 515 |[39m   })[33m;[39m[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:512:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè ÔøΩÔøΩ Admin Routes - Comprehensive Test Suite ‚Ä∫ ÔøΩÔøΩ Employees ‚Ä∫ PUT /employees/:id ‚Ä∫ should reject invalid fields with 400

    expected 400 "Bad Request", got 500 "Internal Server Error"

    [0m [90m 613 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
     [90m 614 |[39m           [33m.[39msend({ invalid_field[33m:[39m [32m'value'[39m })
    [31m[1m>[22m[39m[90m 615 |[39m           [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m            [31m[1m^[22m[39m
     [90m 616 |[39m
     [90m 617 |[39m         expect(response[33m.[39mbody[33m.[39mcode)[33m.[39mtoBe([32m'INVALID_FIELDS'[39m)[33m;[39m
     [90m 618 |[39m         expect(response[33m.[39mbody[33m.[39minvalidFields)[33m.[39mtoEqual([[32m'invalid_field'[39m])[33m;[39m[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:615:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè ÔøΩÔøΩ Admin Routes - Comprehensive Test Suite ‚Ä∫ ÔøΩÔøΩ Employees ‚Ä∫ POST /employees/:id/approve ‚Ä∫ should return 404 for non-existent

    expected 404 "Not Found", got 500 "Internal Server Error"

    [0m [90m 652 |[39m           [33m.[39mpost([32m'/api/admin/employees/non-existent/approve'[39m)
     [90m 653 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
    [31m[1m>[22m[39m[90m 654 |[39m           [33m.[39mexpect([35m404[39m)[33m;[39m
     [90m     |[39m            [31m[1m^[22m[39m
     [90m 655 |[39m       })[33m;[39m
     [90m 656 |[39m
     [90m 657 |[39m       it([32m'should send notification'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:654:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè ÔøΩÔøΩ Admin Routes - Comprehensive Test Suite ‚Ä∫ ÔøΩÔøΩ Employees ‚Ä∫ POST /employees/:id/approve ‚Ä∫ should send notification

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

    [0m [90m 676 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])[33m;[39m
     [90m 677 |[39m
    [31m[1m>[22m[39m[90m 678 |[39m         expect(mockNotify)[33m.[39mtoHaveBeenCalled()[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 679 |[39m       })[33m;[39m
     [90m 680 |[39m     })[33m;[39m
     [90m 681 |[39m[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:678:28)

  ‚óè ÔøΩÔøΩ Admin Routes - Comprehensive Test Suite ‚Ä∫ ÔøΩÔøΩ Employees ‚Ä∫ POST /employees/:id/reject ‚Ä∫ should send rejection notification

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

    [0m [90m 723 |[39m           [33m.[39msend({ reason[33m:[39m [32m'Test'[39m })[33m;[39m
     [90m 724 |[39m
    [31m[1m>[22m[39m[90m 725 |[39m         expect(mockNotify)[33m.[39mtoHaveBeenCalled()[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 726 |[39m       })[33m;[39m
     [90m 727 |[39m
     [90m 728 |[39m       it([32m'should require rejection reason'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:725:28)

  ‚óè ÔøΩÔøΩ Admin Routes - Comprehensive Test Suite ‚Ä∫ ÔøΩÔøΩ Employees ‚Ä∫ POST /employees/:id/reject ‚Ä∫ should require rejection reason

    expected 400 "Bad Request", got 500 "Internal Server Error"

    [0m [90m 734 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
     [90m 735 |[39m           [33m.[39msend({})
    [31m[1m>[22m[39m[90m 736 |[39m           [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m            [31m[1m^[22m[39m
     [90m 737 |[39m
     [90m 738 |[39m         expect(response[33m.[39mbody[33m.[39mcode)[33m.[39mtoBe([32m'REASON_REQUIRED'[39m)[33m;[39m
     [90m 739 |[39m         expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoContain([32m'Rejection reason is required'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:736:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè ÔøΩÔøΩ Admin Routes - Comprehensive Test Suite ‚Ä∫ ÔøΩÔøΩ Users ‚Ä∫ PUT /users/:id ‚Ä∫ should return 404 for non-existent

    expected 404 "Not Found", got 500 "Internal Server Error"

    [0m [90m 837 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
     [90m 838 |[39m           [33m.[39msend({ pseudonym[33m:[39m [32m'new'[39m })
    [31m[1m>[22m[39m[90m 839 |[39m           [33m.[39mexpect([35m404[39m)[33m;[39m
     [90m     |[39m            [31m[1m^[22m[39m
     [90m 840 |[39m       })[33m;[39m
     [90m 841 |[39m
     [90m 842 |[39m       it([32m'should reject invalid fields with 400'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:839:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè ÔøΩÔøΩ Admin Routes - Comprehensive Test Suite ‚Ä∫ ÔøΩÔøΩ Users ‚Ä∫ PUT /users/:id ‚Ä∫ should reject invalid fields with 400

    expected 400 "Bad Request", got 500 "Internal Server Error"

    [0m [90m 871 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
     [90m 872 |[39m           [33m.[39msend({ invalid_field[33m:[39m [32m'value'[39m })
    [31m[1m>[22m[39m[90m 873 |[39m           [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m            [31m[1m^[22m[39m
     [90m 874 |[39m
     [90m 875 |[39m         expect(response[33m.[39mbody[33m.[39mcode)[33m.[39mtoBe([32m'INVALID_FIELDS'[39m)[33m;[39m
     [90m 876 |[39m         expect(response[33m.[39mbody[33m.[39minvalidFields)[33m.[39mtoEqual([[32m'invalid_field'[39m])[33m;[39m[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:873:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè ÔøΩÔøΩ Admin Routes - Comprehensive Test Suite ‚Ä∫ ÔøΩÔøΩ Users ‚Ä∫ POST /users/:id/role ‚Ä∫ should return 404 for non-existent user

    expected 404 "Not Found", got 500 "Internal Server Error"

    [0m [90m 921 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
     [90m 922 |[39m           [33m.[39msend({ role[33m:[39m [32m'moderator'[39m })
    [31m[1m>[22m[39m[90m 923 |[39m           [33m.[39mexpect([35m404[39m)[33m;[39m
     [90m     |[39m            [31m[1m^[22m[39m
     [90m 924 |[39m       })[33m;[39m
     [90m 925 |[39m     })[33m;[39m
     [90m 926 |[39m[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:923:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè ÔøΩÔøΩ Admin Routes - Comprehensive Test Suite ‚Ä∫ ÔøΩÔøΩ Users ‚Ä∫ POST /users/:id/toggle-active ‚Ä∫ should return 404 for non-existent user

    expected 404 "Not Found", got 500 "Internal Server Error"

    [0m [90m 960 |[39m           [33m.[39mpost([32m'/api/admin/users/ffffffff-ffff-ffff-ffff-ffffffffffff/toggle-active'[39m)
     [90m 961 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
    [31m[1m>[22m[39m[90m 962 |[39m           [33m.[39mexpect([35m404[39m)[33m;[39m
     [90m     |[39m            [31m[1m^[22m[39m
     [90m 963 |[39m       })[33m;[39m
     [90m 964 |[39m
     [90m 965 |[39m       it([32m'should handle DB errors'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:962:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè ÔøΩÔøΩ Admin Routes - Comprehensive Test Suite ‚Ä∫ ÔøΩÔøΩ Users ‚Ä∫ POST /users/:id/toggle-active ‚Ä∫ should handle DB errors

    expected 500 "Internal Server Error", got 200 "OK"

    [0m [90m 984 |[39m           [33m.[39mpost([32m'/api/admin/users/eeeeeeee-eeee-eeee-eeee-eeeeeeeeeeee/toggle-active'[39m)
     [90m 985 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
    [31m[1m>[22m[39m[90m 986 |[39m           [33m.[39mexpect([35m500[39m)[33m;[39m
     [90m     |[39m            [31m[1m^[22m[39m
     [90m 987 |[39m       })[33m;[39m
     [90m 988 |[39m     })[33m;[39m
     [90m 989 |[39m   })[33m;[39m[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:986:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè ÔøΩÔøΩ Admin Routes - Comprehensive Test Suite ‚Ä∫ ÔøΩÔøΩ Stats ‚Ä∫ GET /user-stats/:id ‚Ä∫ should return 404 for non-existent user

    expected 404 "Not Found", got 200 "OK"

    [0m [90m 1132 |[39m           [33m.[39m[36mget[39m([32m'/api/admin/user-stats/ffffffff-ffff-ffff-ffff-ffffffffffff'[39m)
     [90m 1133 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
    [31m[1m>[22m[39m[90m 1134 |[39m           [33m.[39mexpect([35m404[39m)[33m;[39m
     [90m      |[39m            [31m[1m^[22m[39m
     [90m 1135 |[39m       })[33m;[39m
     [90m 1136 |[39m
     [90m 1137 |[39m       it([32m'should handle invalid user ID'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:1134:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè ÔøΩÔøΩ Admin Routes - Comprehensive Test Suite ‚Ä∫ ÔøΩÔøΩ Stats ‚Ä∫ GET /user-stats/:id ‚Ä∫ should handle invalid user ID

    expected 404 "Not Found", got 200 "OK"

    [0m [90m 1151 |[39m           [33m.[39m[36mget[39m([32m'/api/admin/user-stats/invalid-id'[39m)
     [90m 1152 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
    [31m[1m>[22m[39m[90m 1153 |[39m           [33m.[39mexpect([35m404[39m)[33m;[39m [90m// Invalid ID treated as user not found[39m
     [90m      |[39m            [31m[1m^[22m[39m
     [90m 1154 |[39m       })[33m;[39m
     [90m 1155 |[39m     })[33m;[39m
     [90m 1156 |[39m   })[33m;[39m[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:1153:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè ÔøΩÔøΩ Admin Routes - Comprehensive Test Suite ‚Ä∫ ÔøΩÔøΩ Comments ‚Ä∫ POST /comments/:id/approve ‚Ä∫ should return 404 for non-existent

    expected 404 "Not Found", got 500 "Internal Server Error"

    [0m [90m 1255 |[39m           [33m.[39mpost([32m'/api/admin/comments/ffffffff-ffff-ffff-ffff-ffffffffffff/approve'[39m)
     [90m 1256 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
    [31m[1m>[22m[39m[90m 1257 |[39m           [33m.[39mexpect([35m404[39m)[33m;[39m
     [90m      |[39m            [31m[1m^[22m[39m
     [90m 1258 |[39m       })[33m;[39m
     [90m 1259 |[39m
     [90m 1260 |[39m       it([32m'should clear reports on approval'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:1257:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè ÔøΩÔøΩ Admin Routes - Comprehensive Test Suite ‚Ä∫ ÔøΩÔøΩ Comments ‚Ä∫ POST /comments/:id/reject ‚Ä∫ should return 404 for non-existent

    expected 404 "Not Found", got 500 "Internal Server Error"

    [0m [90m 1318 |[39m           [33m.[39mpost([32m'/api/admin/comments/ffffffff-ffff-ffff-ffff-ffffffffffff/reject'[39m)
     [90m 1319 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
    [31m[1m>[22m[39m[90m 1320 |[39m           [33m.[39mexpect([35m404[39m)[33m;[39m
     [90m      |[39m            [31m[1m^[22m[39m
     [90m 1321 |[39m       })[33m;[39m
     [90m 1322 |[39m
     [90m 1323 |[39m       it([32m'should resolve reports on rejection'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:1320:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè ÔøΩÔøΩ Admin Routes - Comprehensive Test Suite ‚Ä∫ ÔøΩÔøΩ Comments ‚Ä∫ POST /comments/:id/dismiss-reports ‚Ä∫ should return 404 for non-existent comment

    expected 404 "Not Found", got 200 "OK"

    [0m [90m 1387 |[39m           [33m.[39mpost([32m'/api/admin/comments/ffffffff-ffff-ffff-ffff-ffffffffffff/dismiss-reports'[39m)
     [90m 1388 |[39m           [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [[32m`auth-token=${adminToken}`[39m])
    [31m[1m>[22m[39m[90m 1389 |[39m           [33m.[39mexpect([35m404[39m)[33m;[39m
     [90m      |[39m            [31m[1m^[22m[39m
     [90m 1390 |[39m       })[33m;[39m
     [90m 1391 |[39m
     [90m 1392 |[39m       it([32m'should handle DB errors'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/routes/__tests__/admin.complete.test.ts:1389:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

FAIL src/__tests__/security/sqlInjection.test.ts (29.259 s)
  ‚óè SQL Injection Security Tests ‚Ä∫ GET Query Parameters ‚Ä∫ should sanitize SQL injection in search parameter

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [200, 400]

    [0m [90m 109 |[39m         [90m// Should NOT return 500 (SQL error)[39m
     [90m 110 |[39m         [90m// Should return 200 or 400 (validation error)[39m
    [31m[1m>[22m[39m[90m 111 |[39m         expect([[35m200[39m[33m,[39m [35m400[39m])[33m.[39mtoContain(response[33m.[39mstatus)[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 112 |[39m
     [90m 113 |[39m         [90m// Should NOT expose SQL error messages[39m
     [90m 114 |[39m         [36mif[39m (response[33m.[39mbody[33m.[39merror) {[0m

      at Object.<anonymous> (src/__tests__/security/sqlInjection.test.ts:111:28)

  ‚óè SQL Injection Security Tests ‚Ä∫ GET Query Parameters ‚Ä∫ should sanitize SQL injection in zone filter

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [200, 400]

    [0m [90m 124 |[39m           [33m.[39mquery({ zone[33m:[39m payload })[33m;[39m
     [90m 125 |[39m
    [31m[1m>[22m[39m[90m 126 |[39m         expect([[35m200[39m[33m,[39m [35m400[39m])[33m.[39mtoContain(response[33m.[39mstatus)[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 127 |[39m
     [90m 128 |[39m         [36mif[39m (response[33m.[39mbody[33m.[39merror) {
     [90m 129 |[39m           expect(response[33m.[39mbody[33m.[39merror)[33m.[39mnot[33m.[39mtoMatch([35m/SQL|syntax|pg_/i[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/security/sqlInjection.test.ts:126:28)

  ‚óè SQL Injection Security Tests ‚Ä∫ GET Query Parameters ‚Ä∫ should sanitize SQL injection in status filter

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [200, 400]

    [0m [90m 138 |[39m           [33m.[39mquery({ status[33m:[39m payload })[33m;[39m
     [90m 139 |[39m
    [31m[1m>[22m[39m[90m 140 |[39m         expect([[35m200[39m[33m,[39m [35m400[39m])[33m.[39mtoContain(response[33m.[39mstatus)[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 141 |[39m
     [90m 142 |[39m         [36mif[39m (response[33m.[39mbody[33m.[39merror) {
     [90m 143 |[39m           expect(response[33m.[39mbody[33m.[39merror)[33m.[39mnot[33m.[39mtoMatch([35m/SQL|syntax|pg_/i[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/security/sqlInjection.test.ts:140:28)

  ‚óè SQL Injection Security Tests ‚Ä∫ Search and Filter Combinations ‚Ä∫ should sanitize multiple SQL injection payloads in one request

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [200, 400]

    [0m [90m 224 |[39m         })[33m;[39m
     [90m 225 |[39m
    [31m[1m>[22m[39m[90m 226 |[39m       expect([[35m200[39m[33m,[39m [35m400[39m])[33m.[39mtoContain(response[33m.[39mstatus)[33m;[39m
     [90m     |[39m                          [31m[1m^[22m[39m
     [90m 227 |[39m
     [90m 228 |[39m       [36mif[39m (response[33m.[39mbody[33m.[39merror) {
     [90m 229 |[39m         expect(response[33m.[39mbody[33m.[39merror)[33m.[39mnot[33m.[39mtoMatch([35m/SQL|syntax|pg_|DROP|DELETE|INSERT|UPDATE/i[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/security/sqlInjection.test.ts:226:26)

  ‚óè SQL Injection Security Tests ‚Ä∫ Supabase RLS Policy Verification ‚Ä∫ should respect RLS policies and not bypass with SQL injection

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [200, 400]

    [0m [90m 343 |[39m         [90m// Should return normal results (empty or filtered)[39m
     [90m 344 |[39m         [90m// Should NOT bypass RLS and return admin-only data[39m
    [31m[1m>[22m[39m[90m 345 |[39m         expect([[35m200[39m[33m,[39m [35m400[39m])[33m.[39mtoContain(response[33m.[39mstatus)[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 346 |[39m
     [90m 347 |[39m         [36mif[39m (response[33m.[39mstatus [33m===[39m [35m200[39m [33m&&[39m response[33m.[39mbody[33m.[39mestablishments) {
     [90m 348 |[39m           [90m// Verify no sensitive admin data is exposed[39m[0m

      at Object.<anonymous> (src/__tests__/security/sqlInjection.test.ts:345:28)

FAIL src/__tests__/vip/vipVerification.test.ts (26.991 s)
  ‚óè VIP Admin Verification Tests ‚Ä∫ GET /api/admin/vip/transactions ‚Ä∫ should return all VIP transactions for admin

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 81 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 82 |[39m         [33m.[39m[36mget[39m([32m'/api/admin/vip/transactions'[39m)
    [31m[1m>[22m[39m[90m 83 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m    |[39m          [31m[1m^[22m[39m
     [90m 84 |[39m
     [90m 85 |[39m       expect(response[33m.[39mbody)[33m.[39mtoHaveProperty([32m'success'[39m[33m,[39m [36mtrue[39m)[33m;[39m
     [90m 86 |[39m       expect(response[33m.[39mbody)[33m.[39mtoHaveProperty([32m'transactions'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipVerification.test.ts:83:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Admin Verification Tests ‚Ä∫ GET /api/admin/vip/transactions ‚Ä∫ should filter transactions by payment status

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 106 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 107 |[39m         [33m.[39m[36mget[39m([32m'/api/admin/vip/transactions?status=pending'[39m)
    [31m[1m>[22m[39m[90m 108 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 109 |[39m
     [90m 110 |[39m       expect(response[33m.[39mbody[33m.[39mtransactions[33m.[39mlength)[33m.[39mtoBe([35m1[39m)[33m;[39m
     [90m 111 |[39m       expect(response[33m.[39mbody[33m.[39mtransactions[[35m0[39m][33m.[39mpayment_status)[33m.[39mtoBe([32m'pending'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipVerification.test.ts:108:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Admin Verification Tests ‚Ä∫ GET /api/admin/vip/transactions ‚Ä∫ should filter transactions by payment method

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 129 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 130 |[39m         [33m.[39m[36mget[39m([32m'/api/admin/vip/transactions?payment_method=cash'[39m)
    [31m[1m>[22m[39m[90m 131 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 132 |[39m
     [90m 133 |[39m       expect(response[33m.[39mbody[33m.[39mtransactions[33m.[39mlength)[33m.[39mtoBe([35m1[39m)[33m;[39m
     [90m 134 |[39m       expect(response[33m.[39mbody[33m.[39mtransactions[[35m0[39m][33m.[39mpayment_method)[33m.[39mtoBe([32m'cash'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipVerification.test.ts:131:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Admin Verification Tests ‚Ä∫ GET /api/admin/vip/transactions ‚Ä∫ should include joined data (user, employee/establishment, subscription)

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 177 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 178 |[39m         [33m.[39m[36mget[39m([32m'/api/admin/vip/transactions'[39m)
    [31m[1m>[22m[39m[90m 179 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 180 |[39m
     [90m 181 |[39m       [36mconst[39m transaction [33m=[39m response[33m.[39mbody[33m.[39mtransactions[[35m0[39m][33m;[39m
     [90m 182 |[39m       expect(transaction)[33m.[39mtoHaveProperty([32m'user'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipVerification.test.ts:179:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Admin Verification Tests ‚Ä∫ POST /api/admin/vip/verify-payment/:transactionId ‚Ä∫ should verify payment and activate subscription successfully

    expected 200 "OK", got 403 "Forbidden"

    [0m [90m 248 |[39m           admin_notes[33m:[39m [32m'Cash payment verified in person'[39m
     [90m 249 |[39m         })
    [31m[1m>[22m[39m[90m 250 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 251 |[39m
     [90m 252 |[39m       expect(response[33m.[39mbody)[33m.[39mtoHaveProperty([32m'success'[39m[33m,[39m [36mtrue[39m)[33m;[39m
     [90m 253 |[39m       expect(response[33m.[39mbody[33m.[39mtransaction[33m.[39mpayment_status)[33m.[39mtoBe([32m'completed'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipVerification.test.ts:250:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Admin Verification Tests ‚Ä∫ POST /api/admin/vip/verify-payment/:transactionId ‚Ä∫ should return 404 if transaction does not exist

    expected 404 "Not Found", got 403 "Forbidden"

    [0m [90m 267 |[39m           admin_notes[33m:[39m [32m'Test'[39m
     [90m 268 |[39m         })
    [31m[1m>[22m[39m[90m 269 |[39m         [33m.[39mexpect([35m404[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 270 |[39m
     [90m 271 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoContain([32m'Transaction not found'[39m)[33m;[39m
     [90m 272 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipVerification.test.ts:269:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Admin Verification Tests ‚Ä∫ POST /api/admin/vip/verify-payment/:transactionId ‚Ä∫ should return 400 if payment is already verified

    expected 400 "Bad Request", got 403 "Forbidden"

    [0m [90m 289 |[39m           admin_notes[33m:[39m [32m'Test'[39m
     [90m 290 |[39m         })
    [31m[1m>[22m[39m[90m 291 |[39m         [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 292 |[39m
     [90m 293 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoContain([32m'already verified'[39m)[33m;[39m
     [90m 294 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipVerification.test.ts:291:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Admin Verification Tests ‚Ä∫ POST /api/admin/vip/verify-payment/:transactionId ‚Ä∫ should populate admin audit fields (admin_verified_by, admin_verified_at, admin_notes)

    expected 200 "OK", got 403 "Forbidden"

    [0m [90m 348 |[39m           admin_notes[33m:[39m [32m'Verified via bank transfer receipt'[39m
     [90m 349 |[39m         })
    [31m[1m>[22m[39m[90m 350 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 351 |[39m
     [90m 352 |[39m       expect(capturedUpdate)[33m.[39mtoHaveProperty([32m'payment_status'[39m[33m,[39m [32m'completed'[39m)[33m;[39m
     [90m 353 |[39m       expect(capturedUpdate)[33m.[39mtoHaveProperty([32m'admin_verified_by'[39m[33m,[39m [32m'admin-user-id'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipVerification.test.ts:350:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Admin Verification Tests ‚Ä∫ POST /api/admin/vip/reject-payment/:transactionId ‚Ä∫ should reject payment and cancel subscription successfully

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 416 |[39m           admin_notes[33m:[39m [32m'Payment receipt invalid'[39m
     [90m 417 |[39m         })
    [31m[1m>[22m[39m[90m 418 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 419 |[39m
     [90m 420 |[39m       expect(response[33m.[39mbody)[33m.[39mtoHaveProperty([32m'success'[39m[33m,[39m [36mtrue[39m)[33m;[39m
     [90m 421 |[39m       expect(response[33m.[39mbody[33m.[39mtransaction[33m.[39mpayment_status)[33m.[39mtoBe([32m'failed'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipVerification.test.ts:418:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Admin Verification Tests ‚Ä∫ POST /api/admin/vip/reject-payment/:transactionId ‚Ä∫ should return 400 if transaction is already rejected

    expected 400 "Bad Request", got 500 "Internal Server Error"

    [0m [90m 449 |[39m           admin_notes[33m:[39m [32m'Test'[39m
     [90m 450 |[39m         })
    [31m[1m>[22m[39m[90m 451 |[39m         [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 452 |[39m
     [90m 453 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoBeDefined()[33m;[39m
     [90m 454 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipVerification.test.ts:451:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè VIP Admin Verification Tests ‚Ä∫ POST /api/admin/vip/reject-payment/:transactionId ‚Ä∫ should update entity VIP status to false when rejecting

    expected 200 "OK", got 400 "Bad Request"

    [0m [90m 513 |[39m           admin_notes[33m:[39m [32m'Invalid payment'[39m
     [90m 514 |[39m         })
    [31m[1m>[22m[39m[90m 515 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 516 |[39m
     [90m 517 |[39m       expect(capturedEntityUpdate)[33m.[39mtoHaveProperty([32m'is_vip'[39m[33m,[39m [36mfalse[39m)[33m;[39m
     [90m 518 |[39m       expect(capturedEntityUpdate)[33m.[39mtoHaveProperty([32m'vip_expires_at'[39m[33m,[39m [36mnull[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/vip/vipVerification.test.ts:515:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)


Test Suites: 4 failed, 23 passed, 27 total
Tests:       49 failed, 4 skipped, 539 passed, 592 total
Snapshots:   0 total
Time:        34.241 s
Ran all test suites.
