name: E2E Nightly

# Runs comprehensive E2E tests every night at 2 AM UTC
# Tests are split into parallel jobs by category for faster execution

on:
  schedule:
    - cron: '0 2 * * *' # Every day at 2 AM UTC
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  issues: write
  pull-requests: write

env:
  NODE_VERSION: '20.x'

jobs:
  # Shared setup job - builds and uploads artifacts
  setup:
    name: Setup & Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install frontend dependencies
        run: npm ci --legacy-peer-deps

      - name: Build frontend
        run: npm run build
        env:
          CI: true
          GENERATE_SOURCEMAP: false
          REACT_APP_SUPABASE_URL: ${{ secrets.REACT_APP_SUPABASE_URL }}
          REACT_APP_SUPABASE_ANON_KEY: ${{ secrets.REACT_APP_SUPABASE_ANON_KEY }}

      - name: Install backend dependencies
        run: npm ci
        working-directory: backend

      - name: Build backend
        run: npm run build
        working-directory: backend

      - name: Upload frontend build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: build/
          retention-days: 1

      - name: Upload backend build
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: backend/dist/
          retention-days: 1

  # Job 1: Smoke Tests (Critical Path)
  e2e-smoke:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        project: [chromium-desktop, chromium-mobile, chromium-tablet]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Install backend dependencies
        run: npm ci
        working-directory: backend

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: build/

      - name: Download backend build
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: backend/dist/

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Start servers
        run: |
          cd backend && npm start > backend.log 2>&1 &
          sleep 5
          npx serve -s build -l 3000 &
          sleep 3
          echo "Waiting for frontend..."
          timeout 60 bash -c 'until curl -s http://localhost:3000 > /dev/null; do sleep 1; done' || (echo "Frontend failed" && exit 1)
          echo "Waiting for backend..."
          timeout 60 bash -c 'until curl -s http://localhost:8080 > /dev/null 2>&1; do sleep 2; done' || (cat backend/backend.log && exit 1)
          echo "Servers ready!"
        env:
          NODE_ENV: test
          PORT: 8080
          SUPABASE_URL: ${{ secrets.REACT_APP_SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.REACT_APP_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          JWT_SECRET: e2e-test-jwt-secret-that-is-at-least-32-characters-long
          SESSION_SECRET: e2e-test-session-secret-for-ci-pipeline

      - name: Run Smoke Tests
        run: npx playwright test tests/e2e/smoke.spec.ts --project=${{ matrix.project }} --workers=2
        timeout-minutes: 10
        env:
          CI: true
          PLAYWRIGHT_BASE_URL: http://localhost:3000

      - name: Upload report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: report-smoke-${{ matrix.project }}
          path: playwright-report/
          retention-days: 7

  # Job 2: Authentication & User Tests
  e2e-auth:
    name: Auth & User Tests
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 25
    strategy:
      fail-fast: false
      matrix:
        project: [chromium-desktop, chromium-mobile]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Install backend dependencies
        run: npm ci
        working-directory: backend

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: build/

      - name: Download backend build
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: backend/dist/

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Start servers
        run: |
          cd backend && npm start > backend.log 2>&1 &
          sleep 5
          npx serve -s build -l 3000 &
          sleep 3
          timeout 60 bash -c 'until curl -s http://localhost:3000 > /dev/null; do sleep 1; done' || exit 1
          timeout 60 bash -c 'until curl -s http://localhost:8080 > /dev/null 2>&1; do sleep 2; done' || (cat backend/backend.log && exit 1)
        env:
          NODE_ENV: test
          PORT: 8080
          SUPABASE_URL: ${{ secrets.REACT_APP_SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.REACT_APP_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          JWT_SECRET: e2e-test-jwt-secret-that-is-at-least-32-characters-long
          SESSION_SECRET: e2e-test-session-secret-for-ci-pipeline

      - name: Run Auth Tests
        run: |
          npx playwright test \
            tests/e2e/authentication.spec.ts \
            tests/e2e/registration-flows.spec.ts \
            tests/e2e/user-profile-page.spec.ts \
            tests/e2e/user-dashboard.spec.ts \
            tests/e2e/profile-edit.spec.ts \
            --project=${{ matrix.project }} --workers=2
        timeout-minutes: 20
        env:
          CI: true
          PLAYWRIGHT_BASE_URL: http://localhost:3000

      - name: Upload report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: report-auth-${{ matrix.project }}
          path: playwright-report/
          retention-days: 7

  # Job 3: CRUD & Management Tests
  e2e-crud:
    name: CRUD & Management Tests
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        project: [chromium-desktop]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Install backend dependencies
        run: npm ci
        working-directory: backend

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: build/

      - name: Download backend build
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: backend/dist/

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Start servers
        run: |
          cd backend && npm start > backend.log 2>&1 &
          sleep 5
          npx serve -s build -l 3000 &
          sleep 3
          timeout 60 bash -c 'until curl -s http://localhost:3000 > /dev/null; do sleep 1; done' || exit 1
          timeout 60 bash -c 'until curl -s http://localhost:8080 > /dev/null 2>&1; do sleep 2; done' || (cat backend/backend.log && exit 1)
        env:
          NODE_ENV: test
          PORT: 8080
          SUPABASE_URL: ${{ secrets.REACT_APP_SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.REACT_APP_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          JWT_SECRET: e2e-test-jwt-secret-that-is-at-least-32-characters-long
          SESSION_SECRET: e2e-test-session-secret-for-ci-pipeline

      - name: Run CRUD Tests
        run: |
          npx playwright test \
            tests/e2e/employee-crud.spec.ts \
            tests/e2e/employee-detail.spec.ts \
            tests/e2e/establishment-detail.spec.ts \
            tests/e2e/claim-establishment.spec.ts \
            tests/e2e/owner-management.spec.ts \
            tests/e2e/employee-profile-claim.spec.ts \
            tests/e2e/employee-verification.spec.ts \
            tests/e2e/admin-panel.spec.ts \
            tests/e2e/admin-vip-verification.spec.ts \
            --project=${{ matrix.project }} --workers=2
        timeout-minutes: 25
        env:
          CI: true
          PLAYWRIGHT_BASE_URL: http://localhost:3000

      - name: Upload report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: report-crud-${{ matrix.project }}
          path: playwright-report/
          retention-days: 7

  # Job 4: Features Tests (Gamification, VIP, Favorites, etc.)
  e2e-features:
    name: Features Tests
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        project: [chromium-desktop, chromium-mobile]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Install backend dependencies
        run: npm ci
        working-directory: backend

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: build/

      - name: Download backend build
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: backend/dist/

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Start servers
        run: |
          cd backend && npm start > backend.log 2>&1 &
          sleep 5
          npx serve -s build -l 3000 &
          sleep 3
          timeout 60 bash -c 'until curl -s http://localhost:3000 > /dev/null; do sleep 1; done' || exit 1
          timeout 60 bash -c 'until curl -s http://localhost:8080 > /dev/null 2>&1; do sleep 2; done' || (cat backend/backend.log && exit 1)
        env:
          NODE_ENV: test
          PORT: 8080
          SUPABASE_URL: ${{ secrets.REACT_APP_SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.REACT_APP_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          JWT_SECRET: e2e-test-jwt-secret-that-is-at-least-32-characters-long
          SESSION_SECRET: e2e-test-session-secret-for-ci-pipeline

      - name: Run Features Tests
        run: |
          npx playwright test \
            tests/e2e/gamification.spec.ts \
            tests/e2e/gamification-complete.spec.ts \
            tests/e2e/vip-system.spec.ts \
            tests/e2e/vip-payment-flow.spec.ts \
            tests/e2e/favorites.spec.ts \
            tests/e2e/notifications.spec.ts \
            tests/e2e/reviews-ratings.spec.ts \
            --project=${{ matrix.project }} --workers=2
        timeout-minutes: 25
        env:
          CI: true
          PLAYWRIGHT_BASE_URL: http://localhost:3000

      - name: Upload report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: report-features-${{ matrix.project }}
          path: playwright-report/
          retention-days: 7

  # Job 5: UI & Accessibility Tests
  e2e-ui:
    name: UI & Accessibility Tests
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        project: [chromium-desktop, chromium-mobile]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Install backend dependencies
        run: npm ci
        working-directory: backend

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: build/

      - name: Download backend build
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: backend/dist/

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Start servers
        run: |
          cd backend && npm start > backend.log 2>&1 &
          sleep 5
          npx serve -s build -l 3000 &
          sleep 3
          timeout 60 bash -c 'until curl -s http://localhost:3000 > /dev/null; do sleep 1; done' || exit 1
          timeout 60 bash -c 'until curl -s http://localhost:8080 > /dev/null 2>&1; do sleep 2; done' || (cat backend/backend.log && exit 1)
        env:
          NODE_ENV: test
          PORT: 8080
          SUPABASE_URL: ${{ secrets.REACT_APP_SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.REACT_APP_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          JWT_SECRET: e2e-test-jwt-secret-that-is-at-least-32-characters-long
          SESSION_SECRET: e2e-test-session-secret-for-ci-pipeline

      - name: Run UI Tests
        run: |
          npx playwright test \
            tests/e2e/accessibility.spec.ts \
            tests/e2e/accessibility-audit.spec.ts \
            tests/e2e/theme-switching.spec.ts \
            tests/e2e/keyboard-navigation.spec.ts \
            tests/e2e/mobile.spec.ts \
            tests/e2e/buttons-interactions.spec.ts \
            tests/e2e/modals-forms.spec.ts \
            tests/e2e/header-navigation.spec.ts \
            tests/e2e/i18n.spec.ts \
            --project=${{ matrix.project }} --workers=2
        timeout-minutes: 25
        env:
          CI: true
          PLAYWRIGHT_BASE_URL: http://localhost:3000

      - name: Upload report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: report-ui-${{ matrix.project }}
          path: playwright-report/
          retention-days: 7

  # Job 6: Pages & Navigation Tests
  e2e-pages:
    name: Pages & Navigation Tests
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 25
    strategy:
      fail-fast: false
      matrix:
        project: [chromium-desktop, chromium-mobile]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Install backend dependencies
        run: npm ci
        working-directory: backend

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: build/

      - name: Download backend build
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: backend/dist/

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Start servers
        run: |
          cd backend && npm start > backend.log 2>&1 &
          sleep 5
          npx serve -s build -l 3000 &
          sleep 3
          timeout 60 bash -c 'until curl -s http://localhost:3000 > /dev/null; do sleep 1; done' || exit 1
          timeout 60 bash -c 'until curl -s http://localhost:8080 > /dev/null 2>&1; do sleep 2; done' || (cat backend/backend.log && exit 1)
        env:
          NODE_ENV: test
          PORT: 8080
          SUPABASE_URL: ${{ secrets.REACT_APP_SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.REACT_APP_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          JWT_SECRET: e2e-test-jwt-secret-that-is-at-least-32-characters-long
          SESSION_SECRET: e2e-test-session-secret-for-ci-pipeline

      - name: Run Pages Tests
        run: |
          npx playwright test \
            tests/e2e/search-page.spec.ts \
            tests/e2e/filters.spec.ts \
            tests/e2e/freelances-page.spec.ts \
            tests/e2e/not-found-page.spec.ts \
            tests/e2e/user-search-flow.spec.ts \
            tests/e2e/visit-history-page.spec.ts \
            tests/e2e/sidebar-establishment.spec.ts \
            --project=${{ matrix.project }} --workers=2
        timeout-minutes: 20
        env:
          CI: true
          PLAYWRIGHT_BASE_URL: http://localhost:3000

      - name: Upload report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: report-pages-${{ matrix.project }}
          path: playwright-report/
          retention-days: 7

  # Job 7: Maps & Performance Tests
  e2e-maps-perf:
    name: Maps & Performance Tests
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 25
    strategy:
      fail-fast: false
      matrix:
        project: [chromium-desktop]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Install backend dependencies
        run: npm ci
        working-directory: backend

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: build/

      - name: Download backend build
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: backend/dist/

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Start servers
        run: |
          cd backend && npm start > backend.log 2>&1 &
          sleep 5
          npx serve -s build -l 3000 &
          sleep 3
          timeout 60 bash -c 'until curl -s http://localhost:3000 > /dev/null; do sleep 1; done' || exit 1
          timeout 60 bash -c 'until curl -s http://localhost:8080 > /dev/null 2>&1; do sleep 2; done' || (cat backend/backend.log && exit 1)
        env:
          NODE_ENV: test
          PORT: 8080
          SUPABASE_URL: ${{ secrets.REACT_APP_SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.REACT_APP_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          JWT_SECRET: e2e-test-jwt-secret-that-is-at-least-32-characters-long
          SESSION_SECRET: e2e-test-session-secret-for-ci-pipeline

      - name: Run Maps & Performance Tests
        run: |
          npx playwright test \
            tests/e2e/map-interactions.spec.ts \
            tests/e2e/map-performance.spec.ts \
            tests/e2e/performance-audit.spec.ts \
            tests/e2e/network-errors.spec.ts \
            tests/e2e/error-handling.spec.ts \
            tests/e2e/photo-upload.spec.ts \
            tests/e2e/pwa.spec.ts \
            --project=${{ matrix.project }} --workers=2
        timeout-minutes: 20
        env:
          CI: true
          PLAYWRIGHT_BASE_URL: http://localhost:3000

      - name: Upload report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: report-maps-perf-${{ matrix.project }}
          path: playwright-report/
          retention-days: 7

  # Notify on failure - creates GitHub issue
  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [e2e-smoke, e2e-auth, e2e-crud, e2e-features, e2e-ui, e2e-pages, e2e-maps-perf]
    if: failure()

    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const body = [
              '## E2E Nightly Tests Failed',
              '',
              `**Date:** ${date}`,
              `**Run ID:** ${context.runId}`,
              '',
              '### Test Categories',
              'The following test categories were executed:',
              '- Smoke Tests',
              '- Auth & User Tests',
              '- CRUD & Management Tests',
              '- Features Tests (Gamification, VIP, etc.)',
              '- UI & Accessibility Tests',
              '- Pages & Navigation Tests',
              '- Maps & Performance Tests',
              '',
              '### Details',
              `Check the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for detailed logs and artifacts.`,
              '',
              '### Artifacts',
              'Test reports have been uploaded as artifacts for each failed job.',
              '',
              '---',
              '*This issue was automatically created by the E2E Nightly workflow.*'
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `E2E Nightly Tests Failed - ${date}`,
              body: body,
              labels: ['bug', 'e2e-tests', 'automated']
            });
